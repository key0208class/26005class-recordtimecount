<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è“®å°çµ‚é»è¨ˆæ™‚çµ„ v2.6.1</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼â–¼
        //
        //    ğŸ‘‰ è«‹ç¢ºèªæ‚¨çš„ Firebase Config è¨­å®š
        //
        const firebaseConfig = {
          apiKey: "AIzaSyDwVzBE6JSC9UhFQ2rGyzRX1wCae-YhUYI",
          authDomain: "myclass26005-recordtime.firebaseapp.com",
          databaseURL: "https://myclass26005-recordtime-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "myclass26005-recordtime",
          storageBucket: "myclass26005-recordtime.firebasestorage.app",
          messagingSenderId: "902094530267",
          appId: "1:902094530267:web:ad4d7709c1835d02564efe"
        };
        //
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        try {
            if (typeof firebaseConfig !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase åˆå§‹åŒ–æˆåŠŸï¼");
            } else {
                console.warn("Firebase Config æœªè¨­å®šï¼Œå°‡ä»¥æœ¬æ©Ÿæ¨¡å¼é‹è¡Œã€‚");
            }
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
        }
    </script>
    
    <style>
        /* === å…¨å±€å­—é«”èˆ‡åŸºç¤æ¨£å¼ === */
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f3f4f6; font-size: 16px; }
        /* === v2.5.0 æ–°å¢æ¨£å¼ï¼šé¸æ‰‹æ¨™ç±¤ === */
        .player-tag { display: block; font-size: 0.75rem; line-height: 1.2; color: #4b5563; background-color: rgba(255,255,255,0.6); padding: 1px 4px; border-radius: 4px; margin: 0 auto 2px auto; max-width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 600; cursor: pointer; transition: background-color 0.2s; }
        .player-tag:hover { background-color: #fff; color: #2563eb; }
       .btn-assign-player { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            width: 28px;   /* ä¿®æ”¹é€™è£¡ï¼šå¯¬åº¦è®Šå¤§ (åŸæœ¬20px) */
            height: 28px;  /* ä¿®æ”¹é€™è£¡ï¼šé«˜åº¦è®Šå¤§ (åŸæœ¬20px) */
            background-color: #3b82f6; 
            color: white; 
            border-radius: 50%; 
            font-size: 18px; /* ä¿®æ”¹é€™è£¡ï¼šç¬¦è™Ÿè®Šå¤§ (åŸæœ¬14px) */
            line-height: 1; 
            border: 2px solid white; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            cursor: pointer; 
            position: absolute; 
            top: -18px;    /* ä¿®æ”¹é€™è£¡ï¼šä½ç½®ç¨å¾®å¾€å³ä¸Šè§’å¤–æ¨ï¼Œé¿å…é®æ“‹ */
            right: -18px;  /* ä¿®æ”¹é€™è£¡ï¼šä½ç½®ç¨å¾®å¾€å³ä¸Šè§’å¤–æ¨ */
            transition: transform 0.2s, background-color 0.2s; 
            z-index: 10; 
        }
        .btn-assign-player:hover { background-color: #2563eb; transform: scale(1.1); }
        .time-cell-content { position: relative; display: inline-block; min-width: 80px; } /* è®“å…§å®¹ç›¸å°å®šä½ä»¥ä¾¿æ”¾ç½®æŒ‰éˆ• */
        /* Modal å‹•ç•« */
        .modal { transition: opacity 0.25s ease, transform 0.25s ease; }
        .modal-content { transition: transform 0.25s ease; }
        .modal.hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal.visible { opacity: 1; transform: scale(1); }
        
        /* Toast æç¤ºæ¨£å¼ */
        .toast { 
            position: fixed; 
            bottom: 80px; 
            left: 50%; 
            transform: translateX(-50%); 
            padding: 8px 16px; 
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: 500;
            z-index: 200; 
            opacity: 0; 
            transition: opacity 0.3s ease, bottom 0.3s ease; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
            white-space: nowrap;
        }
        .toast.show { opacity: 1; bottom: 100px; }
        .toast-success { background-color: rgba(40, 167, 69, 0.95); color: white; backdrop-filter: blur(4px); }
        .toast-error { background-color: rgba(220, 53, 69, 0.95); color: white; backdrop-filter: blur(4px); }

        /* è¡¨æ ¼æ¨£å¼ */
        .time-cell { 
            cursor: pointer; text-align: center; padding: 12px 6px; 
            font-family: 'monospace', 'Courier New'; font-size: 1.2rem; 
            transition: background-color 0.2s ease, color 0.2s ease; 
            min-width: 90px; vertical-align: top; 
        }
        tr:not(.row-complete-highlight) .time-cell:hover { background-color: #eff6ff; }
        
        .time-cell.error { color: #ef4444; font-weight: bold; background-color: #fee2e2; animation: pulse-red 0.8s ease-in-out; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        
        .time-cell-placeholder { color: #d1d5db; font-size: 1.3rem; font-weight: 600; line-height: 1.4; }
        
        /* æŒ‰éˆ•èˆ‡åœ–ç¤º */
        .cell-action-btn { background: none; border: none; cursor: pointer; padding: 6px; border-radius: 6px; transition: background-color 0.2s; color: #6b7280; }
        .cell-action-btn:hover { background-color: #e5e7eb; color: #3b82f6; }
        .cell-action-btn svg { width: 1.25rem; height: 1.25rem; }

        .cell-ok-btn { background: none; border: none; cursor: pointer; padding: 6px; border-radius: 6px; transition: background-color 0.2s; color: #10b981; }
        .cell-ok-btn:hover { background-color: #d1fae5; color: #059669; }
        .cell-ok-btn svg { width: 1.25rem; height: 1.25rem; }
        .cell-ok-btn.active { background-color: #10b981; color: white; }
        
        .header-action-btn { display: inline-flex; align-items: center; justify-content: center; background-color: #4f46e5; color: white; font-weight: 500; padding: 6px; border-radius: 6px; transition: background-color 0.2s; width: 32px; height: 32px; cursor: pointer; font-size: 1.25rem; line-height: 1; }
        .header-action-btn:hover { background-color: #4338ca; }

        /* å¿«ç…§èˆ‡ç‹€æ…‹ */
        .saved-record-item { display: flex; align-items: center; background-color: #fdfba2; border: 1px solid #e7d98b; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); transition: all 0.2s ease; }
        .saved-record-item:hover { transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .saved-record-btn { background: none; border: none; color: #725a03; padding: 4px 10px; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .saved-record-btn:hover { background-color: #fcf891; }
        .delete-record-btn { background: #fcf891; color: #a18a07; padding: 4px 8px; border: none; border-left: 1px solid #e7d98b; cursor: pointer; height: 100%; transition: background-color 0.2s, color 0.2s; }
        .delete-record-btn:hover { background: #ef4444; color: white; }
        .delete-record-btn svg { width: 1rem; height: 1rem; }
        
        .btn-disabled { opacity: 0.6; cursor: not-allowed; background-color: #9ca3af !important; }
        
        .conflict-btn-container { display: flex; justify-content: center; align-items: center; gap: 4px; margin-top: 4px; }
        .conflict-btn { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; border-radius: 6px; padding: 2px 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; font-size: 0.75rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; }
        .conflict-btn:hover { background-color: #fee2e2; color: #991b1b; }
        .conflict-btn svg { width: 1rem; height: 1rem; }
        .cell-sort-btn { background-color: #fef2f2; color: #b91c1c; border: none; padding: 4px; border-radius: 6px; transition: background-color 0.2s; cursor: pointer; }
        .cell-sort-btn:hover { background-color: #fee2e2; }
        .cell-sort-btn svg { width: 1.25rem; height: 1.25rem; }
        
        .connection-status { display: inline-flex; align-items: center; gap: 6px; font-size: 0.875rem; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse-animation 2s infinite; }
        .status-connected { background-color: #dcfce7; color: #166534; }
        .status-connected .status-dot { background-color: #22c55e; }
        .status-disconnected { background-color: #fee2e2; color: #991b1b; }
        .status-disconnected .status-dot { background-color: #ef4444; }
        @keyframes pulse-animation { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .admin-status { display: inline-flex; align-items: center; gap: 5px; font-size: 0.875rem; padding: 4px 10px; border-radius: 12px; font-weight: 500; background-color: #f3e8ff; color: #581c87; border: 1px solid #e9d5ff; }
        .admin-status svg { width: 1rem; height: 1rem; }
        
        .row-complete-highlight { background-color: #dcfce7 !important; }
        .row-complete-highlight:hover { background-color: #bbf7d0 !important; }

        /* === æ‡¸æµ®ç¢¼è¡¨æ¨£å¼ v2.1 === */
        #stopwatch-widget {
            position: fixed; bottom: 20px; right: 20px; z-index: 50; 
            display: flex; flex-direction: column; align-items: end; gap: 8px;
        }
        
        .sw-main-panel {
            background-color: #1f2937; /* æ·±ç°åº•è‰² */
            color: #f3f4f6;           /* äº®ç™½æ–‡å­— */
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            border: 2px solid #374151;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: bottom right;
            min-width: 260px;
            position: relative;
        }
        
        .sw-main-panel.minimized {
            transform: scale(0); opacity: 0; pointer-events: none; position: absolute;
        }

        .sw-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px; border-bottom: 1px solid #4b5563; padding-bottom: 4px;
        }

        .sw-settings-btn {
            background: none; border: none; color: #9ca3af; cursor: pointer; padding: 2px; font-size: 1.1rem;
            transition: color 0.2s;
        }
        .sw-settings-btn:hover { color: #ffffff; }
        
        /* è¨­å®šé¸å–® Popover */
        .sw-settings-menu {
            position: absolute; top: 40px; left: 10px;
            background-color: #374151; border: 1px solid #4b5563;
            border-radius: 8px; padding: 8px;
            display: flex; flex-direction: column; gap: 8px;
            z-index: 60; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            width: 150px;
        }
        .sw-settings-menu.hidden { display: none; }
        
        .sw-setting-item {
            display: flex; align-items: center; justify-content: space-between;
            color: #d1d5db; font-size: 0.85rem;
        }
        /* Toggle Switch */
        .toggle-checkbox { display: none; }
        .toggle-label {
            width: 36px; height: 20px; background-color: #6b7280; border-radius: 9999px;
            position: relative; cursor: pointer; transition: background-color 0.2s;
        }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .toggle-label::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px;
            background-color: white; border-radius: 50%; transition: transform 0.2s;
        }
        .toggle-checkbox:checked + .toggle-label::after { transform: translateX(16px); }

        .sw-time-display {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5rem; font-weight: 700; text-align: center;
            letter-spacing: 2px; margin-bottom: 8px;
            color: #60a5fa; text-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            font-variant-numeric: tabular-nums;
            line-height: 1;
        }
        
        /* Lap List Style v2.1 Modified */
        .sw-laps-container {
            max-height: none; 
            overflow-y: visible;
            margin-bottom: 8px; padding: 4px;
            background: rgba(0,0,0,0.2); border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem; color: #e5e7eb;
            display: flex; flex-direction: column-reverse; 
        }
        
        .sw-lap-item { display: flex; justify-content: space-between; border-bottom: 1px dashed #374151; padding: 2px 4px; }
        .sw-lap-item:last-child { border-bottom: none; }
        .sw-lap-rank { color: #9ca3af; margin-right: 8px; }
        .sw-lap-time { color: #fbbf24; font-weight: bold; }

        .sw-controls { display: flex; justify-content: center; gap: 12px; }

        .sw-btn {
            width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; cursor: pointer; transition: all 0.2s;
            border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .sw-btn:active { transform: scale(0.95); }
        .sw-btn-start { background-color: #10b981; color: white; }
        .sw-btn-start:hover { background-color: #059669; }
        
        .sw-btn-pause { background-color: #f59e0b; color: white; }
        .sw-btn-pause:hover { background-color: #d97706; }
        
        .sw-btn-stop { background-color: #ef4444; color: white; }
        .sw-btn-stop:hover { background-color: #dc2626; }
        
        .sw-btn-lap { background-color: #3b82f6; color: white; }
        .sw-btn-lap:hover { background-color: #2563eb; }

        .sw-btn-reset { background-color: #4b5563; color: #d1d5db; width: 48px; height: 48px; font-size: 1.25rem; }
        .sw-btn-reset:hover { background-color: #374151; color: white; }

        .sw-toggle-btn {
            width: 56px; height: 56px; border-radius: 50%;
            background-color: #2563eb; color: white; font-size: 1.75rem;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.4);
            transition: all 0.3s; border: 2px solid white; z-index: 51;
        }
        .sw-toggle-btn:hover { background-color: #1d4ed8; transform: scale(1.05); }
        .sw-toggle-btn.active { background-color: #ef4444; }

        /* åˆ—å°è¨­å®š */
        @media print {
            body { font-size: 12px; background-color: white; }
            header, footer, #event-modal, #edit-event-modal, #time-input-modal, #save-record-modal, #custom-confirm-modal, #actions-modal, #btn-open-modal, #toast-container, #password-modal, #stopwatch-widget, .no-print {
                display: none !important;
            }
            .container { max-w-full; padding: 0; margin: 0; }
            .bg-white { box-shadow: none; border-radius: 0; overflow: visible; }
            .overflow-x-auto { overflow: visible; }
            table { width: 100%; min-width: 0; border-collapse: collapse; border: 1px solid #ccc; }
            th, td { border: 1px solid #ccc; padding: 6px 8px; font-size: 11px; }
            thead { background-color: #e5e7eb !important; color: #1f2937 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            tr { page-break-inside: avoid; }
            .time-cell { font-size: 11.5px; min-width: auto; padding: 6px 4px; }
            .time-cell-placeholder { display: none; }
            .cell-action-btn, .conflict-btn-container, .cell-sort-btn, .cell-ok-btn { display: none; }
            .row-complete-highlight { background-color: #dcfce7 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">

    <div id="toast-container"></div>

    <div id="stopwatch-widget" class="no-print">
        <div id="sw-panel" class="sw-main-panel minimized">
            <div class="sw-header">
                <button id="sw-settings-toggle" class="sw-settings-btn" title="è¨­å®š">âš™ï¸</button>
                <div class="flex flex-col items-end">
                    <span class="text-xs font-bold text-gray-400 tracking-wider uppercase">Pro Stopwatch</span>
                    <span class="text-[10px] text-gray-500">åƒ…æœ¬æ©Ÿæœ‰æ•ˆ</span>
                </div>
            </div>
            
            <div id="sw-settings-menu" class="sw-settings-menu hidden">
                <div class="sw-setting-item">
                    <span>ğŸ”Š éŸ³æ•ˆ</span>
                    <input type="checkbox" id="toggle-sound" class="toggle-checkbox">
                    <label for="toggle-sound" class="toggle-label"></label>
                </div>
                <div class="sw-setting-item">
                    <span>ğŸ“³ éœ‡å‹•</span>
                    <input type="checkbox" id="toggle-vibration" class="toggle-checkbox">
                    <label for="toggle-vibration" class="toggle-label"></label>
                </div>
                <div class="sw-setting-item">
                    <span title="é–‹å•Ÿå¾Œä½¿ç”¨è¨ˆæ¬¡(Split)åŠŸèƒ½">ğŸ”„ é€£çºŒè¨ˆæ™‚</span>
                    <input type="checkbox" id="toggle-continuous" class="toggle-checkbox">
                    <label for="toggle-continuous" class="toggle-label"></label>
                </div>
            </div>

            <div id="sw-laps-list" class="sw-laps-container hidden"></div>

            <div id="sw-display" class="sw-time-display">00:00.00</div>
            
            <div class="sw-controls">
                <button id="sw-btn-reset" class="sw-btn sw-btn-reset" title="æ­¸é›¶ (éœ€ç¢ºèª)">ğŸ”„</button>
                
                <button id="sw-btn-start" class="sw-btn sw-btn-start" title="é–‹å§‹">â–¶ï¸</button>
                <button id="sw-btn-pause" class="sw-btn sw-btn-pause hidden" title="æš«åœ">â¸ï¸</button>

                <button id="sw-btn-lap" class="sw-btn sw-btn-lap hidden" title="è¨ˆæ¬¡ (Split)">â±ï¸</button>
                <button id="sw-btn-stop" class="sw-btn sw-btn-stop hidden" title="åœæ­¢">ğŸ›‘</button>
            </div>
        </div>
        
        <button id="sw-toggle-btn" class="sw-toggle-btn" title="é–‹å•Ÿ/é—œé–‰ ç¢¼è¡¨">
            â±ï¸
        </button>
    </div>

    <div class="container mx-auto max-w-7xl">
        
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 flex-wrap">
                <h1 class="text-3xl font-bold text-gray-800 tracking-tight">ğŸ… è“®å°çµ‚é»è¨ˆæ™‚çµ„ <span class="text-sm font-normal text-gray-500 align-middle">v2.6.1</span></h1>
                
                <div id="connection-status-container" class="no-print">
                    <div class="connection-status status-disconnected">
                        <div class="status-dot"></div>
                        <span>é›¢ç·š</span>
                    </div>
                </div>
                
                <div id="admin-mode-badge" class="hidden no-print">
                    <div class="admin-status">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd"></path></svg>
                        <span>ç®¡ç†è€…æ¨¡å¼</span>
                    </div>
                </div>

                <div id="cloud-snapshots-container" class="flex flex-wrap gap-2 items-center"></div>
            </div>

            <div class="flex items-center bg-white rounded-lg shadow-sm p-2 gap-2 no-print border border-gray-200">
                <span class="text-gray-700 mr-2 font-medium">é¡¯ç¤ºåæ¬¡ï¼š</span>
                <button id="btn-rank-minus" class="bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg>
                </button>
                <span id="rank-count-display" class="mx-2 text-lg font-bold text-blue-600 w-8 text-center">7</span>
                <button id="btn-rank-plus" class="bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-full w-8 h-8 flex items-center justify-center transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </button>
            </div>
        </header>

        <div class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200">
            <div class="overflow-x-auto">
                <table id="events-table" class="w-full min-w-[1000px]">
                    <thead class="bg-blue-600 text-white"></thead>
                    <tbody id="events-table-body" class="text-gray-700"></tbody>
                </table>
            </div>
            <footer class="p-4 border-t border-gray-200 no-print">
                <button id="btn-open-modal" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2 shadow-sm">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span>æ–°å¢é …ç›®</span>
                </button>
            </footer>
        </div>
    </div>

    <div id="event-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 sm:p-8 transform">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">æ–°å¢é‹å‹•é …ç›® ğŸƒ</h2>
                <button id="btn-close-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            <form id="event-form">
                <div class="space-y-5">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div>
                            <label for="select-grade" class="block text-sm font-medium text-gray-700 mb-1">å¹´ç´š</label>
                            <select id="select-grade" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                                <option value="ä¸€">ä¸€å¹´ç´š</option><option value="äºŒ">äºŒå¹´ç´š</option><option value="ä¸‰">ä¸‰å¹´ç´š</option><option value="å››">å››å¹´ç´š</option><option value="äº”">äº”å¹´ç´š</option><option value="å…­">å…­å¹´ç´š</option>
                            </select>
                        </div>
                        <div>
                            <label for="select-gender" class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ¥</label>
                            <select id="select-gender" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                                <option value="ç”·">ç”·ç”Ÿ</option><option value="å¥³">å¥³ç”Ÿ</option><option value="æ··">æ··åˆ</option>
                            </select>
                        </div>
                        <div>
                            <label for="select-event" class="block text-sm font-medium text-gray-700 mb-1">é …ç›®</label>
                            <select id="select-event" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                                <option value="60M">60M</option><option value="100M">100M</option><option value="200M">200M</option><option value="400Mæ¥åŠ›">400Mæ¥åŠ›</option><option value_A="å¤§éšŠæ¥åŠ›A">å¤§éšŠæ¥åŠ›A</option><option value="å¤§éšŠæ¥åŠ›B">å¤§éšŠæ¥åŠ›B</option><option value="è¶£å‘³ç«¶è³½">è¶£å‘³ç«¶è³½</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="input-custom-name" class="block text-sm font-medium text-gray-700 mb-1">è‡ªè¨‚é …ç›®åç¨± (å–®é …)</label>
                        <input type="text" id="input-custom-name" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="ä¾‹å¦‚ï¼šäºŒå¹´ç´š60mè¶£å‘³è³½è·‘">
                    </div>
                    <div class="flex items-center">
                        <span class="flex-grow border-t border-gray-300"></span>
                        <span class="mx-4 text-gray-500 text-sm">æˆ–</span>
                        <span class="flex-grow border-t border-gray-300"></span>
                    </div>
                    <div>
                        <label for="batch-event-input" class="block text-sm font-medium text-gray-700 mb-1">æ‰¹æ¬¡é …ç›®è¼¸å…¥ (æ¯è¡Œä¸€å€‹)</label>
                        <textarea id="batch-event-input" rows="5" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="ä¸‰å¥³100m&#10;ä¸‰ç”·100m&#10;å››å¥³100m..."></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" id="btn-cancel-modal" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-5 rounded-lg transition duration-200">å–æ¶ˆ</button>
                        <button type="submit" id="btn-save-event" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200">å„²å­˜é …ç›®</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <div id="edit-event-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6 sm:p-8 transform">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">ğŸ“ ç·¨è¼¯é …ç›®</h2>
                <button id="btn-close-edit-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            
            <form id="edit-event-form" class="space-y-6">
                <div>
                    <label for="edit-event-name" class="block text-sm font-bold text-gray-700 mb-1">é …ç›®åç¨±</label>
                    <input type="text" id="edit-event-name" class="w-full rounded-lg border-2 border-blue-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 text-lg text-gray-800" placeholder="é …ç›®åç¨±">
                </div>

                <div>
                    <label for="edit-event-index" class="block text-sm font-bold text-gray-700 mb-1">èª¿æ•´åºè™Ÿ (ç¸½æ•¸: <span id="total-events-count">0</span>)</label>
                    <div class="flex items-center justify-center gap-3">
                        <button type="button" id="btn-decrease-index" class="w-12 h-12 rounded-lg bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-600 flex items-center justify-center border border-gray-300 text-xl font-bold transition">â¬†ï¸</button>
                        <input type="number" id="edit-event-index" class="w-24 rounded-lg border-2 border-gray-300 p-3 text-center text-2xl font-bold text-blue-600 focus:border-blue-500 focus:outline-none" min="1">
                        <button type="button" id="btn-increase-index" class="w-12 h-12 rounded-lg bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-600 flex items-center justify-center border border-gray-300 text-xl font-bold transition">â¬‡ï¸</button>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-5 flex flex-col gap-3">
				<div class="mb-2">
                        <div class="flex justify-between items-end mb-1">
                            <label for="edit-event-players" class="block text-sm font-bold text-gray-700">ğŸƒ é¸æ‰‹åå–® (é¸å¡«)</label>
                            <button type="button" id="btn-clear-player-input" class="text-xs text-red-500 hover:text-red-700 underline bg-transparent border-none cursor-pointer transition">ğŸ—‘ï¸ å…¨éƒ¨æ¸…é™¤</button>
                        </div>
                        <textarea id="edit-event-players" rows="3" class="w-full rounded-lg border-2 border-gray-200 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 text-sm" placeholder="è«‹è¼¸å…¥é¸æ‰‹å§“åï¼Œä»¥ç©ºæ ¼æˆ–æ›è¡Œåˆ†éš” (ä¾‹: 601ç‹å°æ˜ 602æå¤§è¯)"></textarea>
                        <p class="text-xs text-gray-500 mt-1 text-right">è¼¸å…¥å¾Œï¼Œæˆç¸¾æ¬„ä½å°‡å‡ºç¾ + è™Ÿä¾›é¸å–</p>
                    </div>
                    <div class="flex gap-3">
                        <button type="button" id="btn-duplicate-event" class="flex-1 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 border border-indigo-200 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition">
                            <span>ğŸ“‹</span> è¤‡è£½æ­¤é …ç›®
                        </button>
                        <button type="button" id="btn-delete-event-modal" class="flex-1 bg-red-50 text-red-600 hover:bg-red-100 border border-red-200 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition">
                            <span>ğŸ—‘ï¸</span> åˆªé™¤
                        </button>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 text-white hover:bg-blue-700 font-bold py-3 px-5 rounded-lg shadow-md transition duration-200 flex items-center justify-center gap-2 mt-2">
                        <span>ğŸ’¾</span> å„²å­˜ä¿®æ”¹
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="time-input-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 sm:p-8 transform">
            <h2 id="time-modal-title" class="text-xl font-bold text-gray-800 mb-4">è¼¸å…¥æ™‚é–“</h2>
            
            <div id="lap-selection-view" class="hidden mb-4">
                <p class="text-sm text-gray-500 mb-2 font-medium">è«‹é»é¸è¦å¸¶å…¥çš„åˆ†æ®µæ™‚é–“ï¼š</p>
                <div id="lap-selection-list" class="max-h-48 overflow-y-auto border border-gray-200 rounded-lg bg-gray-50 mb-3">
                    </div>
                <button type="button" id="btn-cancel-lap-select" class="w-full bg-gray-200 text-gray-700 font-medium py-2 rounded-lg hover:bg-gray-300 transition">å–æ¶ˆè¿”å›</button>
            </div>

            <div id="time-input-main-view">
                <div class="mb-6 flex flex-col gap-2 justify-center">
                    <button type="button" id="btn-import-stopwatch" class="w-full bg-indigo-50 text-indigo-700 border border-indigo-200 hover:bg-indigo-100 font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                        <span class="text-xl">â±ï¸</span>
                        <span>å¸¶å…¥ç¢¼è¡¨æ™‚é–“ (å–®ç­†)</span>
                    </button>
                    <button type="button" id="btn-import-splits" class="hidden w-full bg-green-50 text-green-700 border border-green-200 hover:bg-green-100 font-bold py-2 px-4 rounded-lg transition duration-200 flex items-center justify-center gap-2">
                        <span class="text-xl">ğŸš€</span>
                        <span>å¸¶å…¥åˆ†æ®µè¨ˆæ™‚ (å…¨éƒ¨)</span>
                    </button>
                </div>
                <form id="time-input-form">
                    <div class="grid grid-cols-3 gap-3">
                        <div>
                            <label for="time-min" class="block text-sm font-medium text-gray-700 text-center">åˆ† (M)</label>
                            <input type="number" id="time-min" min="0" max="59" class="w-full text-center text-lg p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border">
                        </div>
                        <div>
                            <label for="time-sec" class="block text-sm font-medium text-gray-700 text-center">ç§’ (S)</label>
                            <input type="number" id="time-sec" min="0" max="59" class="w-full text-center text-lg p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border">
                        </div>
                        <div>
                            <label for="time-cs" class="block text-sm font-medium text-gray-700 text-center">æ¯«ç§’ (CS)</label>
                            <input type="number" id="time-cs" min="0" max="99" class="w-full text-center text-lg p-3 rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 border">
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-6">
                        <button type="button" id="btn-delete-time" class="bg-red-50 text-red-600 hover:bg-red-100 font-medium py-2 px-5 rounded-lg transition duration-200 border border-red-100">åˆªé™¤</button>
                        <div class="flex gap-3">
                            <button type="button" id="btn-cancel-time" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-5 rounded-lg transition duration-200">å–æ¶ˆ</button>
                            <button type="submit" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200">å„²å­˜</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div id="player-select-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[65] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform flex flex-col max-h-[80vh]">
            <header class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-xl font-bold text-gray-800">ğŸƒ é¸æ“‡é¸æ‰‹ <span id="player-select-rank-display" class="text-blue-600 ml-2"></span></h2>
                <button id="btn-close-player-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            <div class="mb-2 flex-shrink-0">
                <p class="text-sm text-gray-500">è«‹é»æ“Šä¸‹æ–¹é¸æ‰‹ä»¥åˆ†é…æˆç¸¾ï¼Œæˆ–é»æ“Šã€Œæ¸…é™¤ã€ç§»é™¤ç›®å‰é¸æ‰‹ã€‚</p>
            </div>
            <div id="player-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-3 overflow-y-auto p-1">
                </div>
            <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center flex-shrink-0">
                <button type="button" id="btn-clear-player" class="text-red-500 hover:text-red-700 font-medium text-sm px-3 py-2 rounded hover:bg-red-50 transition">âŒ æ¸…é™¤ç›®å‰é¸æ‰‹</button>
                <button type="button" id="btn-cancel-player-select" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-5 rounded-lg transition duration-200">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
    <div id="save-record-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 sm:p-8 transform">
            <h2 class="text-xl font-bold text-gray-800 mb-6">å„²å­˜é›²ç«¯å¿«ç…§ â˜ï¸</h2>
            <form id="save-record-form">
                <div>
                    <label for="record-title" class="block text-sm font-medium text-gray-700 mb-1">ç´€éŒ„æ¨™é¡Œ</label>
                    <input type="text" id="record-title" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border" placeholder="ä¾‹å¦‚ï¼š11/28 ä¸Šåˆ (é›²ç«¯å¿«ç…§)" required>
                </div>
                <div class="flex justify-end gap-3 pt-6">
                    <button type="button" id="btn-cancel-save-record" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-5 rounded-lg transition duration-200">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="custom-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md p-6 sm:p-8 transform">
            <div class="flex items-start gap-4">
                <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0">
                    <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" /></svg>
                </div>
                <div class="mt-0 sm:ml-4 text-left">
                    <h3 class="text-xl font-semibold leading-6 text-gray-900" id="custom-confirm-title">ç¢ºèªåˆªé™¤</h3>
                    <div class="mt-2"><p class="text-base text-gray-600" id="custom-confirm-message">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</p></div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" id="custom-confirm-cancel" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-5 rounded-lg transition duration-200">å–æ¶ˆ</button>
                <button type="button" id="custom-confirm-ok" class="bg-red-600 text-white hover:bg-red-700 font-medium py-2 px-5 rounded-lg transition duration-200 btn-disabled" disabled>ç¢ºå®š (3)</button>
            </div>
        </div>
    </div>
    
    <div id="actions-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 transform">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-gray-800">æ“ä½œé¸å–® âš™ï¸</h2>
                <button id="btn-close-actions-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            <div class="space-y-3">
                <button id="btn-action-save" class="w-full flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                    â˜ï¸ å„²å­˜ (é›²ç«¯å¿«ç…§)
                </button>
                <button id="btn-action-export-html" class="w-full flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    ç¶²é  (HTML)
                </button>
                <button id="btn-action-delete-all" class="w-full flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    åˆªé™¤å…¨éƒ¨é …ç›®
                </button>
				<button id="btn-action-referee" class="w-full flex items-center justify-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"></path></svg>
                    ğŸ‘® è£åˆ¤äººå“¡è¨­å®š
                </button>
                <button id="btn-action-logout-admin" class="w-full hidden flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-medium py-3 px-5 rounded-lg transition duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9"></path></svg>
                    é€€å‡ºç®¡ç†è€…æ¨¡å¼
                </button>
            </div>
        </div>
    </div>

    <div id="password-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-xs p-6 sm:p-8 transform">
            <h2 class="text-xl font-bold text-gray-800 mb-6">ğŸ”’ éœ€è¦æ¬Šé™</h2>
            <form id="password-form">
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">è«‹è¼¸å…¥å¯†ç¢¼</label>
                    <input type="password" id="password-input" class="w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2 border">
                    <p id="password-error" class="text-red-500 text-sm mt-2 hidden">å¯†ç¢¼éŒ¯èª¤</p>
                </div>
                <div class="flex justify-end gap-3 pt-6">
                    <button type="button" id="btn-cancel-password" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-5 rounded-lg transition duration-200">å–æ¶ˆ</button>
                    <button type="submit" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200">ç¢ºèª</button>
                </div>
            </form>
        </div>
    </div>
<div id="referee-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] p-4 no-print">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-4xl p-6 h-[90vh] flex flex-col transform">
            <header class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ‘® è£åˆ¤èˆ‡å·¥ä½œåˆ†é…</h2>
                <button id="btn-close-referee-modal" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>
            
            <div class="flex-grow overflow-hidden flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/3 flex flex-col">
                    <label class="block text-sm font-bold text-gray-700 mb-2">ğŸ“‹ è£åˆ¤äººå“¡åå†Š (ä¸€è¡Œä¸€å€‹)</label>
                    <textarea id="referee-list-input" class="flex-grow w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-3 border text-base" placeholder="ç‹å°æ˜&#10;æå¤§è¯&#10;å¼µä¸‰è±..."></textarea>
                    <div class="mt-2 flex justify-between">
                        <button type="button" id="btn-clear-referees" class="text-red-500 text-sm hover:text-red-700 font-medium">æ¸…ç©ºåå†Š</button>
                        <span class="text-gray-500 text-sm">è¼¸å…¥å¾Œå³å´å¯é¸å–</span>
                    </div>
                </div>

                <div class="w-full md:w-2/3 flex flex-col overflow-hidden bg-gray-50 rounded-lg border border-gray-200">
                    <div class="p-3 bg-gray-100 border-b border-gray-200 font-bold text-gray-700 flex justify-between items-center">
                        <span>ğŸ“Š å·¥ä½œåˆ†é…</span>
                        <button type="button" id="btn-add-custom-role" class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded hover:bg-indigo-200 transition">+ è‡ªè¨‚å·¥ä½œ</button>
                    </div>
                    
                    <div class="overflow-y-auto p-4 space-y-4" id="referee-assignments-container">
                        <div id="rank-assignments-list" class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4 border-b border-gray-200 pb-4"></div>
                        
                        <div id="custom-assignments-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end gap-3 pt-4 flex-shrink-0 border-t border-gray-100 mt-4">
                <button type="button" id="btn-cancel-referee" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-5 rounded-lg transition duration-200">å–æ¶ˆ</button>
                <button type="button" id="btn-save-referee" class="bg-blue-600 text-white hover:bg-blue-700 font-medium py-2 px-5 rounded-lg transition duration-200 shadow-md">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            let db; 
            const APP_DATA_PATH = 'appData'; 
            const SNAPSHOTS_PATH = 'cloudSnapshots'; 
            const isFirebaseEnabled = (typeof firebase !== 'undefined' && typeof firebaseConfig !== 'undefined');
            if (isFirebaseEnabled) {
                try {
                    db = firebase.database();
                } catch(e) { console.error("ç„¡æ³•å–å¾— Firebase Database å¯¦ä¾‹:", e); }
            }

            // Audio Context for Beep
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            function playBeep() {
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.15); 
            }

            // --- State Management ---
            let state = {
                rankCount: 7, maxRank: 12, minRank: 1,
                events: [],
                refereeConfig: { names: [], assignments: {}, customRoles: [] }, // æ–°å¢è£åˆ¤è¨­å®š
               editingTime: { eventIndex: null, rank: null },
                assigningPlayer: { eventIndex: null, rank: null }, // v2.5.0 æ–°å¢ï¼šæ­£åœ¨åˆ†é…é¸æ‰‹çš„ç‹€æ…‹
                confirmCallback: null, confirmInterval: null, 
                deleteTimeConfirmation: false, deleteTimeTimeout: null,
                passwordCallback: null,
                isAdminAuthenticated: false,
                editingEventIndex: null,
                stopwatch: {
                    isRunning: false,
                    startTime: 0,
                    elapsedTime: 0, // å–®æ¬¡ç´¯è¨ˆ
                    intervalId: null,
                    isExpanded: false,
                    isContinuous: false, 
                    laps: [], 
                    settings: {
                        sound: false,
                        vibration: false
                    }
                }
            };

            // --- DOM Elements ---
            const rankCountDisplay = document.getElementById('rank-count-display');
            const btnRankMinus = document.getElementById('btn-rank-minus');
            const btnRankPlus = document.getElementById('btn-rank-plus');
            const tableHead = document.querySelector('#events-table thead');
            const tableBody = document.getElementById('events-table-body');
            const toastContainer = document.getElementById('toast-container');
            
            // Modals
            const eventModal = document.getElementById('event-modal');
            const btnOpenModal = document.getElementById('btn-open-modal');
            const btnCloseModal = document.getElementById('btn-close-modal');
            const btnCancelModal = document.getElementById('btn-cancel-modal');
            const eventForm = document.getElementById('event-form');
            const selectGrade = document.getElementById('select-grade');
            const selectGender = document.getElementById('select-gender');
            const selectEvent = document.getElementById('select-event');
            const inputCustomName = document.getElementById('input-custom-name');
            const batchEventInput = document.getElementById('batch-event-input');

            // Edit Modal
            const editEventModal = document.getElementById('edit-event-modal');
            const btnCloseEditModal = document.getElementById('btn-close-edit-modal');
            const editEventForm = document.getElementById('edit-event-form');
            const editEventNameInput = document.getElementById('edit-event-name');
            const editEventIndexInput = document.getElementById('edit-event-index');
            const btnDecreaseIndex = document.getElementById('btn-decrease-index');
            const btnIncreaseIndex = document.getElementById('btn-increase-index');
            const totalEventsCountSpan = document.getElementById('total-events-count');
            const btnDuplicateEvent = document.getElementById('btn-duplicate-event');
           const btnDeleteEventModal = document.getElementById('btn-delete-event-modal');
            const editEventPlayersInput = document.getElementById('edit-event-players'); // v2.5.0
            const btnClearPlayerInput = document.getElementById('btn-clear-player-input'); // v2.6.0
            
            // v2.5.0 Player Select Modal
            const playerSelectModal = document.getElementById('player-select-modal');
            const btnClosePlayerModal = document.getElementById('btn-close-player-modal');
            const btnCancelPlayerSelect = document.getElementById('btn-cancel-player-select');
            const playerGrid = document.getElementById('player-grid');
            const playerSelectRankDisplay = document.getElementById('player-select-rank-display');
            const btnClearPlayer = document.getElementById('btn-clear-player');
            
            // Time Input Modal & Lap Selection
            const timeInputModal = document.getElementById('time-input-modal');
            const timeModalTitle = document.getElementById('time-modal-title');
            const timeInputForm = document.getElementById('time-input-form');
            const timeInputMainView = document.getElementById('time-input-main-view'); // v2.2.0
            const lapSelectionView = document.getElementById('lap-selection-view'); // v2.2.0
            const lapSelectionList = document.getElementById('lap-selection-list'); // v2.2.0
            const btnCancelLapSelect = document.getElementById('btn-cancel-lap-select'); // v2.2.0

            const timeMin = document.getElementById('time-min');
            const timeSec = document.getElementById('time-sec');
            const timeCs = document.getElementById('time-cs');
            const btnCancelTime = document.getElementById('btn-cancel-time');
            const btnDeleteTime = document.getElementById('btn-delete-time');
            const btnImportStopwatch = document.getElementById('btn-import-stopwatch');
            const btnImportSplits = document.getElementById('btn-import-splits'); 
            
            // Cloud Snapshots
            const cloudSnapshotsContainer = document.getElementById('cloud-snapshots-container');
            const saveRecordModal = document.getElementById('save-record-modal');
            const saveRecordForm = document.getElementById('save-record-form');
            const recordTitleInput = document.getElementById('record-title');
            const btnCancelSaveRecord = document.getElementById('btn-cancel-save-record');
            
            // Confirm Modal
            const customConfirmModal = document.getElementById('custom-confirm-modal');
            const customConfirmTitle = document.getElementById('custom-confirm-title');
            const customConfirmMessage = document.getElementById('custom-confirm-message');
            const customConfirmCancel = document.getElementById('custom-confirm-cancel');
            const customConfirmOk = document.getElementById('custom-confirm-ok');
            
            // Actions & Password
            const actionsModal = document.getElementById('actions-modal');
            const btnCloseActionsModal = document.getElementById('btn-close-actions-modal');
            const btnActionSave = document.getElementById('btn-action-save');
            const btnActionExportHtml = document.getElementById('btn-action-export-html');
            const btnActionDeleteAll = document.getElementById('btn-action-delete-all');
            const connectionStatusContainer = document.getElementById('connection-status-container');
            const passwordModal = document.getElementById('password-modal');
            const passwordForm = document.getElementById('password-form');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            const btnCancelPassword = document.getElementById('btn-cancel-password');
            const adminModeBadge = document.getElementById('admin-mode-badge'); 
            const btnActionLogoutAdmin = document.getElementById('btn-action-logout-admin');

            // Stopwatch Elements
            const swToggleBtn = document.getElementById('sw-toggle-btn');
            const swPanel = document.getElementById('sw-panel');
            const swDisplay = document.getElementById('sw-display');
            const swBtnStart = document.getElementById('sw-btn-start');
            const swBtnPause = document.getElementById('sw-btn-pause');
            const swBtnReset = document.getElementById('sw-btn-reset');
            const swBtnLap = document.getElementById('sw-btn-lap'); 
            const swBtnStop = document.getElementById('sw-btn-stop'); 
            const swLapsList = document.getElementById('sw-laps-list'); 
            
            const swSettingsToggle = document.getElementById('sw-settings-toggle');
            const swSettingsMenu = document.getElementById('sw-settings-menu');
            const toggleSound = document.getElementById('toggle-sound');
            const toggleVibration = document.getElementById('toggle-vibration');
            const toggleContinuous = document.getElementById('toggle-continuous'); 

            // --- Helpers ---
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => { toast.classList.add('show'); }, 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.parentNode?.removeChild(toast));
                }, 3000); 
            }

            function formatMillis(ms) {
                if (ms === undefined || ms === null || isNaN(ms)) { return ""; }
                const totalCentiseconds = Math.round(ms / 10);
                const minutes = Math.floor(totalCentiseconds / 6000);
                const remainingCentiseconds = totalCentiseconds % 6000;
                const seconds = Math.floor(remainingCentiseconds / 100);
                const centiseconds = remainingCentiseconds % 100;
                const pad = (n) => String(n).padStart(2, '0');
                if (minutes > 0) {
                    return `${pad(minutes)}'${pad(seconds)}"${pad(centiseconds)}`;
                } else {
                    return `${pad(seconds)}"${pad(centiseconds)}`;
                }
            }
            
            function formatStopwatchTime(ms) {
                const totalCentiseconds = Math.floor(ms / 10);
                const minutes = Math.floor(totalCentiseconds / 6000);
                const remainingCentiseconds = totalCentiseconds % 6000;
                const seconds = Math.floor(remainingCentiseconds / 100);
                const centiseconds = remainingCentiseconds % 100;
                const pad = (n) => String(n).padStart(2, '0');
                return `${pad(minutes)}:${pad(seconds)}.${pad(centiseconds)}`;
            }

            function parseTime(min, sec, cs) {
                min = parseInt(min, 10) || 0;
                sec = parseInt(sec, 10) || 0;
                cs = parseInt(cs, 10) || 0;
                if (min === 0 && sec === 0 && cs === 0 && (timeMin.value === '' && timeSec.value === '' && timeCs.value === '')) {
                     return null;
                }
                return (min * 60000) + (sec * 1000) + (cs * 10);
            }

            // --- Auth & Password ---
            const ADMIN_PASSWORD = 'alp';
            function openPasswordModal(callback) {
                if (state.isAdminAuthenticated) { callback(); return; }
                state.passwordCallback = callback;
                passwordInput.value = '';
                passwordError.classList.add('hidden');
                passwordModal.classList.remove('hidden');
                passwordModal.classList.add('visible');
                passwordInput.focus();
            }
            function closePasswordModal() {
                passwordModal.classList.remove('visible');
                passwordModal.classList.add('hidden');
                state.passwordCallback = null;
            }
            function handlePasswordSubmit(e) {
                e.preventDefault();
                if (passwordInput.value === ADMIN_PASSWORD) {
                    state.isAdminAuthenticated = true;
                    adminModeBadge.classList.remove('hidden');
                    if (state.passwordCallback) state.passwordCallback();
                    closePasswordModal();
                    renderTable(); // Re-render to show OK buttons
                    showToast('ğŸ”’ å·²é€²å…¥ç®¡ç†è€…æ¨¡å¼', 'success');
                } else {
                    passwordError.classList.remove('hidden');
                    passwordInput.select();
                }
            }

            // --- Confirm Modal ---
            function showCustomConfirm(title, message, callback, skipCountdown = false) {
                customConfirmTitle.textContent = title;
                customConfirmMessage.textContent = message;
                state.confirmCallback = callback;
                
                if (state.confirmInterval) { clearInterval(state.confirmInterval); state.confirmInterval = null; }

                if (skipCountdown) {
                    customConfirmOk.disabled = false;
                    customConfirmOk.classList.remove('btn-disabled');
                    customConfirmOk.textContent = 'ç¢ºå®š';
                } else {
                    customConfirmOk.disabled = true;
                    customConfirmOk.classList.add('btn-disabled');
                    customConfirmOk.textContent = 'ç¢ºå®š (3)';
                    let countdown = 3;
                    state.confirmInterval = setInterval(() => {
                        countdown--;
                        if (countdown > 0) {
                            customConfirmOk.textContent = `ç¢ºå®š (${countdown})`;
                        } else {
                            clearInterval(state.confirmInterval);
                            state.confirmInterval = null;
                            customConfirmOk.textContent = 'ç¢ºå®š';
                            customConfirmOk.disabled = false;
                            customConfirmOk.classList.remove('btn-disabled');
                        }
                    }, 1000);
                }
                
                customConfirmModal.classList.remove('hidden');
                customConfirmModal.classList.add('visible');
            }
            function hideCustomConfirm() {
                if (state.confirmInterval) { clearInterval(state.confirmInterval); state.confirmInterval = null; }
                customConfirmModal.classList.remove('visible');
                customConfirmModal.classList.add('hidden');
                state.confirmCallback = null;
            }

            // --- Stopwatch Logic v2.2 ---
            
            function getCurrentTime() {
                if (state.stopwatch.isRunning) {
                    const now = Date.now();
                    return state.stopwatch.elapsedTime + (now - state.stopwatch.startTime);
                }
                return state.stopwatch.elapsedTime;
            }

            function updateStopwatchDisplay() {
                const currentElapsed = getCurrentTime();
                swDisplay.textContent = formatStopwatchTime(currentElapsed);
            }

            function renderLaps() {
                swLapsList.innerHTML = '';
                state.stopwatch.laps.forEach((time, index) => {
                    const div = document.createElement('div');
                    div.className = 'sw-lap-item';
                    div.innerHTML = `<span class="sw-lap-rank">${index + 1}.</span><span class="sw-lap-time">${formatStopwatchTime(time)}</span>`;
                    swLapsList.prepend(div); 
                });
            }

            function triggerStopwatchFeedback() {
                if (state.stopwatch.settings.sound) playBeep();
                if (state.stopwatch.settings.vibration && navigator.vibrate) navigator.vibrate(200);
            }

            function toggleContinuousMode(e) {
                const isContinuous = e.target.checked;
                if (state.stopwatch.elapsedTime > 0 || state.stopwatch.isRunning) {
                     showToast('åˆ‡æ›æ¨¡å¼å·²é‡ç½®è¨ˆæ™‚');
                }
                resetStopwatch(true); 
                state.stopwatch.isContinuous = isContinuous;
                updateStopwatchUIState();
            }

            function updateStopwatchUIState() {
                swBtnStart.classList.add('hidden');
                swBtnPause.classList.add('hidden');
                swBtnLap.classList.add('hidden');
                swBtnStop.classList.add('hidden');

                if (state.stopwatch.isContinuous) {
                    swLapsList.classList.remove('hidden');
                    if (state.stopwatch.isRunning) {
                        swBtnLap.classList.remove('hidden');
                        swBtnStop.classList.remove('hidden');
                    } else {
                        swBtnStart.classList.remove('hidden');
                    }
                } else {
                    swLapsList.classList.add('hidden');
                    if (state.stopwatch.isRunning) {
                        swBtnPause.classList.remove('hidden');
                    } else {
                        swBtnStart.classList.remove('hidden');
                    }
                }
            }

            function startStopwatch() {
                if (!state.stopwatch.isRunning) {
                    triggerStopwatchFeedback();
                    state.stopwatch.isRunning = true;
                    state.stopwatch.startTime = Date.now();
                    state.stopwatch.intervalId = requestAnimationFrame(function loop() {
                        if (state.stopwatch.isRunning) {
                            updateStopwatchDisplay();
                            state.stopwatch.intervalId = requestAnimationFrame(loop);
                        }
                    });
                    updateStopwatchUIState();
                }
            }

            function pauseStopwatch() {
                if (state.stopwatch.isRunning) {
                    triggerStopwatchFeedback();
                    state.stopwatch.isRunning = false;
                    cancelAnimationFrame(state.stopwatch.intervalId);
                    const now = Date.now();
                    state.stopwatch.elapsedTime += (now - state.stopwatch.startTime);
                    updateStopwatchDisplay();
                    updateStopwatchUIState();
                }
            }

            function recordLap() {
                if (state.stopwatch.isRunning) {
                    triggerStopwatchFeedback();
                    const currentTotal = getCurrentTime();
                    state.stopwatch.laps.push(currentTotal);
                    renderLaps();
                }
            }

            function stopStopwatch() {
                if (state.stopwatch.isRunning) {
                    triggerStopwatchFeedback();
                    state.stopwatch.isRunning = false;
                    cancelAnimationFrame(state.stopwatch.intervalId);
                    const now = Date.now();
                    state.stopwatch.elapsedTime += (now - state.stopwatch.startTime);
                    updateStopwatchDisplay();
                    updateStopwatchUIState();
                }
            }

            function resetStopwatch(force = false) {
                const doReset = () => {
                    if (state.stopwatch.isRunning) {
                        cancelAnimationFrame(state.stopwatch.intervalId);
                        state.stopwatch.isRunning = false;
                    }
                    state.stopwatch.elapsedTime = 0;
                    state.stopwatch.startTime = 0;
                    state.stopwatch.laps = [];
                    updateStopwatchDisplay();
                    renderLaps();
                    updateStopwatchUIState();
                };

                if (!force && (state.stopwatch.elapsedTime > 0 || state.stopwatch.isRunning)) {
                    showCustomConfirm("é‡ç½®ç¢¼è¡¨", "ç¢ºå®šè¦æ­¸é›¶å—ï¼Ÿç•¶å‰ç´€éŒ„å°‡æ¶ˆå¤±ã€‚", doReset, true);
                } else {
                    doReset();
                }
            }

            function toggleStopwatchPanel() {
                state.stopwatch.isExpanded = !state.stopwatch.isExpanded;
                if (state.stopwatch.isExpanded) {
                    swPanel.classList.remove('minimized');
                    swToggleBtn.classList.add('active');
                    swToggleBtn.innerHTML = 'âœ–';
                } else {
                    swPanel.classList.add('minimized');
                    swToggleBtn.classList.remove('active');
                    swToggleBtn.innerHTML = 'â±ï¸';
                    swSettingsMenu.classList.add('hidden');
                }
            }

            // --- v2.2.0 Logic: Single Import from Split List ---
            function showLapSelectionMenu() {
                lapSelectionList.innerHTML = '';
                
                if (state.stopwatch.laps.length === 0) {
                    showToast('âš ï¸ ç›®å‰æ²’æœ‰åˆ†æ®µç´€éŒ„', 'error');
                    return;
                }

                state.stopwatch.laps.forEach((time, index) => {
                    const btn = document.createElement('button');
                    btn.className = "w-full text-left px-4 py-3 hover:bg-blue-100 border-b border-gray-100 last:border-0 flex justify-between items-center transition";
                    btn.innerHTML = `
                        <span class="font-bold text-gray-500 w-8">${index + 1}.</span>
                        <span class="font-mono text-lg text-blue-600 font-bold">${formatStopwatchTime(time)}</span>
                    `;
                    btn.addEventListener('click', () => {
                        handleLapSelected(time);
                    });
                    lapSelectionList.appendChild(btn);
                });

                // UI Toggle
                timeInputMainView.classList.add('hidden');
                lapSelectionView.classList.remove('hidden');
            }

            function hideLapSelectionMenu() {
                lapSelectionView.classList.add('hidden');
                timeInputMainView.classList.remove('hidden');
            }

            function handleLapSelected(ms) {
                const totalCentiseconds = Math.floor(ms / 10);
                const minutes = Math.floor(totalCentiseconds / 6000);
                const remainingCentiseconds = totalCentiseconds % 6000;
                const seconds = Math.floor(remainingCentiseconds / 100);
                const centiseconds = remainingCentiseconds % 100;
                
                timeMin.value = minutes;
                timeSec.value = seconds;
                timeCs.value = centiseconds;
                
                hideLapSelectionMenu();
                showToast('âœ… å·²å¸¶å…¥é¸æ“‡çš„æ™‚é–“');
            }

            function importStopwatchTime() {
                if (state.stopwatch.isRunning) {
                    showToast('âš ï¸ è«‹å…ˆåœæ­¢ç¢¼è¡¨å¾Œå†å¸¶å…¥', 'error');
                    return;
                }

                // v2.2.0: If Continuous Mode and has laps -> Show Selection Menu
                if (state.stopwatch.isContinuous && state.stopwatch.laps.length > 0) {
                    showLapSelectionMenu();
                    return;
                }

                // Standard Mode Logic (Total Elapsed)
                const ms = state.stopwatch.elapsedTime;
                if (ms === 0) { showToast('âš ï¸ ç¢¼è¡¨ç„¡æ™‚é–“', 'error'); return; }

                const totalCentiseconds = Math.floor(ms / 10);
                const minutes = Math.floor(totalCentiseconds / 6000);
                const remainingCentiseconds = totalCentiseconds % 6000;
                const seconds = Math.floor(remainingCentiseconds / 100);
                const centiseconds = remainingCentiseconds % 100;
                timeMin.value = minutes;
                timeSec.value = seconds;
                timeCs.value = centiseconds;
                showToast('âœ… å·²è¼‰å…¥å–®ç­†æ™‚é–“');
            }

            function importSplitTimes() {
                if (!state.stopwatch.isContinuous) return;
                if (state.stopwatch.laps.length === 0) {
                    showToast('âš ï¸ ç„¡åˆ†æ®µç´€éŒ„', 'error');
                    return;
                }
                
                showCustomConfirm('å¸¶å…¥åˆ†æ®µè¨ˆæ™‚', `å°‡ä¾åºå¸¶å…¥ ${state.stopwatch.laps.length} ç­†æˆç¸¾è‡³ç›®å‰åæ¬¡ï¼Œç¢ºå®šï¼Ÿ`, () => {
                    if (!isFirebaseEnabled) return;
                    const eventIndex = state.editingTime.eventIndex;
                    const updates = {};
                    
                    state.stopwatch.laps.forEach((time, index) => {
                        const rank = index + 1;
                        if (rank <= state.rankCount) {
                            updates[`${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank}`] = time;
                        }
                    });

                    db.ref().update(updates).then(() => {
                        closeTimeInputModal();
                        showToast(`âœ… æˆåŠŸå¸¶å…¥ ${state.stopwatch.laps.length} ç­†æˆç¸¾ï¼`);
                    });
                }, true);
            }

            // --- Rendering ---
            function renderTable() { renderTableHeader(); renderTableBody(); }
            function renderTableHeader() {
                tableHead.innerHTML = '';
                const tr = document.createElement('tr');
                
                // åºè™Ÿ
                const thIndex = document.createElement('th');
                thIndex.textContent = 'åºè™Ÿ';
                thIndex.className = 'py-4 px-4 text-center w-16';
                tr.appendChild(thIndex);
                
                // é …ç›® + è‡ªè¨‚å·¥ä½œäººå“¡
                const thName = document.createElement('th');
                thName.className = 'py-4 px-4 text-left min-w-[250px]';
                
                let customRolesHtml = '';
                if (state.refereeConfig && Array.isArray(state.refereeConfig.customRoles)) {
                    // ç”Ÿæˆè‡ªè¨‚å·¥ä½œäººå“¡ HTML (å£“ç¸®æ ¼å¼)
                    customRolesHtml = state.refereeConfig.customRoles.map(role => {
                        if (!role.name) return '';
                        return `<span class="inline-flex items-center gap-1 bg-yellow-100 text-yellow-800 text-xs px-2 py-0.5 rounded border border-yellow-200 ml-2 whitespace-nowrap" title="${role.role}: ${role.name}"><span class="font-bold">${role.role}:</span><span>${role.name}</span></span>`;
                    }).join('');
                }

                // è¨­å®š Header HTML (ç„¡ç©ºç™½ç¯€é»)
                thName.innerHTML = `<div class="flex justify-between items-center gap-2"><div class="flex-grow flex flex-wrap items-center"><span class="text-base">é …ç›®</span>${customRolesHtml}</div><button id="btn-open-actions-modal" class="header-action-btn no-print" title="æ“ä½œé¸å–®">âš™ï¸</button></div>`;
                tr.appendChild(thName);

                // åæ¬¡ + è£åˆ¤äººå“¡
                const assignments = (state.refereeConfig && state.refereeConfig.assignments) ? state.refereeConfig.assignments : {};
                for (let i = 1; i <= state.rankCount; i++) {
                    const thRank = document.createElement('th');
                    thRank.className = 'py-4 px-3 text-center w-28 align-top';
                    
                    const refereeName = assignments[i] ? `<div class="text-xs text-blue-100 font-normal mt-1 bg-blue-700 bg-opacity-50 rounded px-1 py-0.5 truncate border border-blue-500 border-opacity-30" title="è¨ˆæ™‚è£åˆ¤: ${assignments[i]}">ğŸ‘® ${assignments[i]}</div>` : '';
                    
                    thRank.innerHTML = `<div class="flex flex-col items-center justify-start h-full"><span>${i} å</span>${refereeName}</div>`;
                    tr.appendChild(thRank);
                }
                tableHead.appendChild(tr);
            }

          function renderTableBody() {
                tableBody.innerHTML = ''; 
                const events = Array.isArray(state.events) ? state.events : [];
                if (events.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 2 + state.rankCount; 
                    td.textContent = 'å°šæœªæ–°å¢ä»»ä½•é …ç›®ï¼Œè«‹é»æ“Šä¸‹æ–¹çš„ã€Œæ–°å¢é …ç›®ã€æŒ‰éˆ•ã€‚';
                    td.className = 'text-center text-gray-500 p-8';
                    tr.appendChild(td);
                    tableBody.appendChild(tr);
                    return;
                }
                events.forEach((event, index) => {
                    if (!event) return; 
                    const tr = document.createElement('tr');
                    tr.className = 'border-b border-gray-200 transition duration-150';
                    tr.dataset.eventIndex = index;
                    if (index % 2 !== 0) tr.classList.add('bg-gray-50');
                    
                    // Index
                    const tdIndex = document.createElement('td');
                    tdIndex.className = 'py-3 px-2 text-center font-medium text-gray-600 text-lg';
                    tdIndex.textContent = String(index + 1).padStart(2, '0');
                    tr.appendChild(tdIndex);
                    
                    // Name
                    const tdName = document.createElement('td');
                    tdName.className = 'py-3 px-4 font-medium';
                    const flexContainer = document.createElement('div');
                    flexContainer.className = 'flex justify-between items-center';
                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'flex-grow';
                    const spanName = document.createElement('span');
                    spanName.className = 'event-name text-lg';
                    spanName.textContent = event.name;
                    nameContainer.appendChild(spanName);
                    
                    // Actions
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'flex gap-1 no-print ml-2 items-center';
                    const sortBtnContainer = document.createElement('span');
                    sortBtnContainer.id = `sort-btn-container-${index}`;
                    sortBtnContainer.className = 'ml-1';
                    
                    // Edit Button
                    const editIconSVG = `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L6.815 19.874a2.25 2.25 0 01-1.06.58L3 21l.546-2.828a2.25 2.25 0 01.58-1.06L16.862 4.487z" /></svg>`;
                    const editBtn = document.createElement('button');
                    editBtn.className = 'cell-action-btn btn-open-edit-modal';
                    editBtn.title = 'ç·¨è¼¯é …ç›®èˆ‡åºè™Ÿ';
                    editBtn.innerHTML = editIconSVG;
                    
                    buttonContainer.appendChild(sortBtnContainer);
                    buttonContainer.appendChild(editBtn);

                    // Manual OK Button
                    if (state.isAdminAuthenticated) {
                        const okIconSVG = `<svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                        const okBtn = document.createElement('button');
                        okBtn.className = `cell-ok-btn btn-manual-ok ${event.manualComplete ? 'active' : ''}`;
                        okBtn.title = 'æ‰‹å‹•æ¨™è¨˜å®Œæˆ (å¼·åˆ¶ç¶ è‰²)';
                        okBtn.dataset.eventIndex = index;
                        okBtn.innerHTML = okIconSVG;
                        buttonContainer.appendChild(okBtn);
                    }

                    flexContainer.appendChild(nameContainer);
                    flexContainer.appendChild(buttonContainer);
                    tdName.appendChild(flexContainer);
                    tr.appendChild(tdName);

                    // Ranks
                    const hasPlayersList = (event.players && event.players.length > 0);
                    const playerAssignments = event.playerAssignments || {};

                    for (let i = 1; i <= state.rankCount; i++) {
                        const tdRank = document.createElement('td');
                        tdRank.className = 'time-cell';
                        tdRank.dataset.eventIndex = index;
                        tdRank.dataset.rank = i;
                        tdRank.id = `cell-${index}-${i}`;
                        const timeInMs = (event.ranks && event.ranks[i]) ? event.ranks[i] : null;
                        
                        // v2.6.0 Render Logic (Strict No Whitespace & Admin Check)
                        let cellContent = '';
                        if (timeInMs === undefined || timeInMs === null) {
                            cellContent = `<div class="time-cell-placeholder">${i}</div>`;
                            tdRank.classList.add('empty');
                        } else {
                            // 1. Player Tag
                            let playerHtml = '';
                            if (playerAssignments[i]) {
                                // v2.6.0: å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé¡¯ç¤ºå¯é»æ“Šæ¨£å¼ï¼›å¦å‰‡é¡¯ç¤ºç´”æ–‡å­—æ¨£å¼(ç„¡ hover æ•ˆæœ)
                                const cursorClass = state.isAdminAuthenticated ? 'cursor-pointer hover:bg-white hover:text-blue-600' : 'cursor-default';
                                playerHtml = `<span class="player-tag ${cursorClass}" title="${state.isAdminAuthenticated ? 'é»æ“Šä¿®æ”¹é¸æ‰‹' : 'é¸æ‰‹å§“å'}">${playerAssignments[i]}</span>`;
                            }

                            // 2. Time Display
                            let timeHtml = `<span class="time-text">${formatMillis(timeInMs)}</span>`;

                            // 3. Assign Button (+) (Strictly Admin Only)
                            let btnHtml = '';
                            if (hasPlayersList && state.isAdminAuthenticated) {
                                // ç®¡ç†å“¡æ¨¡å¼ä¸”æœ‰é¸æ‰‹åå–®ï¼Œæ‰é¡¯ç¤º + è™Ÿ
                                if (!playerAssignments[i]) {
                                    btnHtml = `<button class="btn-assign-player no-print" title="åˆ†é…é¸æ‰‹">ï¼‹</button>`;
                                }
                            }
                            
                            // Combine using relative container without whitespace
                            cellContent = `<div class="time-cell-content">${playerHtml}${timeHtml}${btnHtml}</div>`;
                        }
                        
                        const swapBtnContainerId = `swap-btn-container-${index}-${i}`;
                        tdRank.innerHTML = `${cellContent}<div id="${swapBtnContainerId}" class="conflict-btn-container"></div>`;
                        
                        tr.appendChild(tdRank);
                    }
                    tableBody.appendChild(tr);
                    validateEventRow(index);
                });
            }

            function renderCloudSnapshots(snapshot) {
                cloudSnapshotsContainer.innerHTML = '';
                if (!snapshot.exists()) return;
                const snapshots = snapshot.val();
                const sortedKeys = Object.keys(snapshots).sort((a, b) => snapshots[b].createdAt - snapshots[a].createdAt);
                sortedKeys.forEach(key => {
                    const record = snapshots[key];
                    const item = document.createElement('div');
                    item.className = 'saved-record-item no-print';
                    item.innerHTML = `
                        <button class="saved-record-btn" data-key="${key}" title="è¼‰å…¥æ­¤å¿«ç…§">â˜ï¸ ${record.title}</button>
                        <button class="delete-record-btn" data-key="${key}" data-title="${record.title}" title="åˆªé™¤æ­¤é›²ç«¯å¿«ç…§"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    `;
                    cloudSnapshotsContainer.appendChild(item);
                });
            }
// --- v2.5.0 Logic: Player Assignment ---
            
            function openPlayerSelectModal(eventIndex, rank) {
                const event = state.events[eventIndex];
                if (!event || !event.players || event.players.length === 0) {
                    showToast('æ­¤é …ç›®å°šæœªå»ºç«‹é¸æ‰‹åå–®', 'error');
                    return;
                }
                
                state.assigningPlayer = { eventIndex, rank };
                playerSelectRankDisplay.textContent = `(ç¬¬ ${rank} å)`;
                
                // Render Players
                playerGrid.innerHTML = '';
                event.players.forEach(name => {
                    const btn = document.createElement('button');
                    // æª¢æŸ¥æ˜¯å¦å·²è¢«åˆ†é…åˆ°å…¶ä»–åæ¬¡ (é™¤äº†è‡ªå·±)
                    let isAssignedElsewhere = false;
                    let assignedRank = null;
                    if (event.playerAssignments) {
                        for (const [r, pName] of Object.entries(event.playerAssignments)) {
                            if (pName === name && parseInt(r) !== rank) {
                                isAssignedElsewhere = true;
                                assignedRank = r;
                                break;
                            }
                        }
                    }

                    const isCurrentAssigned = (event.playerAssignments && event.playerAssignments[rank] === name);

                    let btnClass = "flex flex-col items-center justify-center p-3 rounded-lg border-2 transition relative ";
                    if (isCurrentAssigned) {
                        btnClass += "bg-blue-100 border-blue-500 text-blue-700 font-bold shadow-md";
                    } else if (isAssignedElsewhere) {
                        btnClass += "bg-gray-100 border-gray-200 text-gray-400 cursor-not-allowed opacity-60";
                    } else {
                        btnClass += "bg-white border-gray-200 hover:border-blue-400 hover:shadow text-gray-700";
                    }
                    
                    btn.className = btnClass;
                    btn.innerHTML = `<span class="text-lg">${name}</span>${isAssignedElsewhere ? `<span class="text-xs text-red-400">(ç¬¬${assignedRank}å)</span>` : ''}`;
                    
                    if (!isAssignedElsewhere) {
                        btn.addEventListener('click', () => assignPlayer(name));
                    }
                    playerGrid.appendChild(btn);
                });

                playerSelectModal.classList.remove('hidden');
                playerSelectModal.classList.add('visible');
            }

            function closePlayerSelectModal() {
                playerSelectModal.classList.remove('visible');
                playerSelectModal.classList.add('hidden');
                state.assigningPlayer = { eventIndex: null, rank: null };
            }

            function assignPlayer(name) {
                if (!isFirebaseEnabled) return;
                const { eventIndex, rank } = state.assigningPlayer;
                if (eventIndex === null || rank === null) return;
                
                // ç›´æ¥æ›´æ–°è·¯å¾‘: events/X/playerAssignments/Y = Name
                db.ref(`${APP_DATA_PATH}/events/${eventIndex}/playerAssignments/${rank}`).set(name).then(() => {
                    closePlayerSelectModal();
                    showToast(`âœ… å·²å°‡ ${name} åˆ†é…è‡³ç¬¬ ${rank} å`);
                });
            }

            function clearAssignedPlayer() {
                if (!isFirebaseEnabled) return;
                const { eventIndex, rank } = state.assigningPlayer;
                if (eventIndex === null || rank === null) return;

                db.ref(`${APP_DATA_PATH}/events/${eventIndex}/playerAssignments/${rank}`).remove().then(() => {
                    closePlayerSelectModal();
                    showToast('å·²æ¸…é™¤è©²åæ¬¡é¸æ‰‹');
                });
            }
            // --- Logic: Event Handling ---
            
            function openEditEventModal(index) {
                const event = state.events[index];
                if (!event) return;
                state.editingEventIndex = index;
                editEventNameInput.value = event.name;
                
                // v2.5.0 è¼‰å…¥é¸æ‰‹åå–®
                if (event.players && Array.isArray(event.players)) {
                    editEventPlayersInput.value = event.players.join(' ');
                } else {
                    editEventPlayersInput.value = '';
                }

                editEventIndexInput.value = index + 1;
                totalEventsCountSpan.textContent = state.events.length;
                editEventModal.classList.remove('hidden');
                editEventModal.classList.add('visible');
                editEventNameInput.focus();
            }

            function closeEditEventModal() {
                editEventModal.classList.remove('visible');
                editEventModal.classList.add('hidden');
                state.editingEventIndex = null;
            }

            function adjustEditIndex(delta) {
                let currentVal = parseInt(editEventIndexInput.value);
                if (isNaN(currentVal)) currentVal = 1;
                let newVal = currentVal + delta;
                if (newVal < 1) newVal = 1;
                if (newVal > state.events.length) newVal = state.events.length;
                editEventIndexInput.value = newVal;
            }

           function handleSaveEditEvent(e) {
                e.preventDefault();
                if (!isFirebaseEnabled) return;
                
                const currentIndex = state.editingEventIndex;
                const newName = editEventNameInput.value.trim();
                const newIndexInputVal = parseInt(editEventIndexInput.value);
                
                // v2.5.0 è™•ç†é¸æ‰‹åå–® (ä»¥ç©ºæ ¼æˆ–æ›è¡Œåˆ‡å‰²ï¼Œéæ¿¾ç©ºå­—ä¸²)
                const playersInput = editEventPlayersInput.value.trim();
                let newPlayers = [];
                if (playersInput) {
                    newPlayers = playersInput.split(/[\s\n\t]+/).filter(p => p.trim() !== '');
                }

                if (!newName) { showToast('åç¨±ä¸å¯ç‚ºç©º', 'error'); return; }
                if (isNaN(newIndexInputVal) || newIndexInputVal < 1) { showToast('åºè™Ÿç„¡æ•ˆ', 'error'); return; }

                const targetIndex = newIndexInputVal - 1;
                let currentEvents = [...state.events];
                
                // æ›´æ–°ç‰©ä»¶å…§å®¹
                currentEvents[currentIndex].name = newName;
                currentEvents[currentIndex].players = newPlayers; 

                // v2.6.0: æ™ºæ…§æ¸…ç†åˆ†é… (è‹¥é¸æ‰‹å·²ä¸åœ¨æ–°åå–®ä¸­ï¼Œå‰‡ç§»é™¤å…¶åˆ†é…)
                // å¦‚æœ newPlayers æ˜¯ç©ºçš„ï¼Œå‰‡ç›´æ¥æ¸…ç©º assignments
                if (newPlayers.length === 0) {
                    currentEvents[currentIndex].playerAssignments = {};
                } else {
                    // è‹¥æœ‰æ–°åå–®ï¼Œæª¢æŸ¥ç¾æœ‰åˆ†é…æ˜¯å¦æœ‰æ•ˆ
                    const validAssignments = {};
                    if(currentEvents[currentIndex].playerAssignments) {
                        for(const [rank, name] of Object.entries(currentEvents[currentIndex].playerAssignments)) {
                            // åªæœ‰ç•¶è¢«åˆ†é…çš„åå­—ï¼Œä¾ç„¶å­˜åœ¨æ–¼æ–°åå–®ä¸­æ™‚ï¼Œæ‰ä¿ç•™
                            if(newPlayers.includes(name)) {
                                validAssignments[rank] = name;
                            }
                        }
                        currentEvents[currentIndex].playerAssignments = validAssignments;
                    }
                }

                if (currentIndex !== targetIndex) {
                    let safeTarget = targetIndex;
                    if (safeTarget >= currentEvents.length) safeTarget = currentEvents.length - 1;
                    if (safeTarget < 0) safeTarget = 0;
                    const itemToMove = currentEvents[currentIndex];
                    currentEvents.splice(currentIndex, 1);
                    currentEvents.splice(safeTarget, 0, itemToMove);
                }

                db.ref(`${APP_DATA_PATH}/events`).set(currentEvents).then(() => {
                    closeEditEventModal();
                    showToast('é …ç›®ä¿®æ”¹èˆ‡é¸æ‰‹åå–®å·²æ›´æ–°');
                });
            }

            function handleDuplicateEvent() {
                if (!isFirebaseEnabled) return;
                const currentIndex = state.editingEventIndex;
                const currentName = editEventNameInput.value.trim();
                if (!currentName) return;
                let currentEvents = [...state.events];
                const newEvent = { name: currentName, ranks: {} };
                currentEvents.splice(currentIndex + 1, 0, newEvent);
                db.ref(`${APP_DATA_PATH}/events`).set(currentEvents).then(() => {
                    closeEditEventModal();
                    showToast(`å·²è¤‡è£½é …ç›®è‡³åºè™Ÿ ${currentIndex + 2}`);
                });
            }

            function deleteEventFromModal() {
                if (state.editingEventIndex === null) return;
                const indexToDelete = state.editingEventIndex;
                closeEditEventModal();
                showCustomConfirm('åˆªé™¤é …ç›®', 'ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ', () => deleteEvent(indexToDelete));
            }

            function deleteEvent(eventIndex) {
                if (!isFirebaseEnabled) return;
                const currentEvents = [...state.events];
                currentEvents.splice(eventIndex, 1);
                db.ref(`${APP_DATA_PATH}/events`).set(currentEvents).then(() => showToast('é …ç›®å·²åˆªé™¤'));
            }
            
            function updateRankCount(change) {
                if (!isFirebaseEnabled) { showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error'); return; }
                const newCount = state.rankCount + change;
                if (newCount >= state.minRank && newCount <= state.maxRank) {
                    db.ref(`${APP_DATA_PATH}/rankCount`).set(newCount).catch(err => showToast(`éŒ¯èª¤: ${err.message}`, 'error'));
                }
            }
            function openEventModal() { eventForm.reset(); eventModal.classList.remove('hidden'); eventModal.classList.add('visible'); }
            function closeEventModal() { eventModal.classList.remove('visible'); eventModal.classList.add('hidden'); }
            function handleSaveEvent(e) {
                e.preventDefault();
                if (!isFirebaseEnabled) { showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•æ“ä½œ', 'error'); return; }
                const batchInput = batchEventInput.value.trim();
                let newEvents = [];
                if (batchInput) {
                    const eventNames = batchInput.split('\n').filter(name => name.trim() !== '');
                    eventNames.forEach(name => newEvents.push({ name: name.trim(), ranks: {} }));
                } else {
                    const customName = inputCustomName.value.trim();
                    let eventName = customName || `${selectGrade.value}${selectGender.value}${selectEvent.value}`;
                    if (eventName) newEvents.push({ name: eventName, ranks: {} });
                }
                if (newEvents.length > 0) {
                    const currentEvents = Array.isArray(state.events) ? [...state.events] : [];
                    db.ref(`${APP_DATA_PATH}/events`).set(currentEvents.concat(newEvents)).then(() => { closeEventModal(); showToast(`æˆåŠŸæ–°å¢ ${newEvents.length} å€‹é …ç›®ï¼`); });
                } else { showToast('è«‹è‡³å°‘å¡«å¯«ä¸€å€‹é …ç›®', 'error'); }
            }
            function deleteAllEvents() {
                if (!isFirebaseEnabled) return;
                db.ref(`${APP_DATA_PATH}/events`).set([]).then(() => showToast('å·²åˆªé™¤æ‰€æœ‰é …ç›®'));
            }

            function openTimeInputModal(eventIndex, rank) {
                const event = state.events[eventIndex];
                if (!event) return;
                state.editingTime = { eventIndex, rank };
                timeModalTitle.textContent = `è¼¸å…¥ ${event.name} (ç¬¬ ${rank} å)`;
                
                // Reset View to Main Input
                hideLapSelectionMenu();

                // UI setup for buttons
                if (state.stopwatch.isContinuous && state.stopwatch.laps.length > 0) {
                    btnImportSplits.classList.remove('hidden');
                    btnImportStopwatch.querySelector('span:last-child').textContent = 'å¸¶å…¥ç¢¼è¡¨æ™‚é–“ (å–®ç­†)';
                } else {
                    btnImportSplits.classList.add('hidden');
                    btnImportStopwatch.querySelector('span:last-child').textContent = 'å¸¶å…¥ç¢¼è¡¨æ™‚é–“';
                }

                const ms = (event.ranks && event.ranks[rank]) ? event.ranks[rank] : null;
                if (ms !== undefined && ms !== null) {
                    const totalCentiseconds = Math.round(ms / 10);
                    timeMin.value = Math.floor(totalCentiseconds / 6000);
                    const remainingCentiseconds = totalCentiseconds % 6000;
                    timeSec.value = Math.floor(remainingCentiseconds / 100);
                    timeCs.value = remainingCentiseconds % 100;
                } else {
                    timeInputForm.reset();
                }
                timeInputModal.classList.remove('hidden');
                timeInputModal.classList.add('visible');
                timeSec.focus();
            }
            function closeTimeInputModal() {
                timeInputModal.classList.remove('visible');
                timeInputModal.classList.add('hidden');
                state.editingTime = { eventIndex: null, rank: null };
                if (state.deleteTimeTimeout) { clearTimeout(state.deleteTimeTimeout); state.deleteTimeTimeout = null; }
                state.deleteTimeConfirmation = false;
                btnDeleteTime.textContent = 'åˆªé™¤';
                btnDeleteTime.classList.remove('bg-red-500', 'text-white');
                btnDeleteTime.classList.add('bg-red-50', 'text-red-600');
            }
            function handleSaveTime(e) {
                e.preventDefault();
                if (!isFirebaseEnabled) return;
                const { eventIndex, rank } = state.editingTime;
                const totalMs = parseTime(timeMin.value, timeSec.value, timeCs.value);
                db.ref(`${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank}`).set(totalMs).then(() => closeTimeInputModal());
            }
            function handleDeleteTimeInternalLogic() {
                if (!isFirebaseEnabled) return;
                const { eventIndex, rank } = state.editingTime;
                db.ref(`${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank}`).set(null).then(() => { closeTimeInputModal(); showToast('æ™‚é–“å·²æ¸…é™¤'); });
            }
            
            function toggleManualComplete(eventIndex) {
                if (!isFirebaseEnabled) return;
                const event = state.events[eventIndex];
                const newStatus = !event.manualComplete;
                db.ref(`${APP_DATA_PATH}/events/${eventIndex}/manualComplete`).set(newStatus).then(() => {
                    showToast(newStatus ? 'âœ… å·²æ‰‹å‹•æ¨™è¨˜å®Œæˆ' : 'â­• å·²å–æ¶ˆå®Œæˆç‹€æ…‹');
                });
            }

            function validateEventRow(eventIndex) {
                const event = state.events[eventIndex];
                if (!event) return;
                const tr = document.querySelector(`tr[data-event-index="${eventIndex}"]`);
                if (!tr) return;
                
                const ranks = event.ranks || {};
                let lastValidTime = -1;
                let lastValidRank = 0;
                let errors = []; 
                let conflictRanks = new Set(); 
                let allRanksWithTime = [];
                let allRanksFilled = true;
                
                tr.classList.remove('row-complete-highlight'); 
                
                for (let i = 1; i <= state.rankCount; i++) {
                    const cell = document.getElementById(`cell-${eventIndex}-${i}`);
                    if (cell) {
                        cell.classList.remove('error');
                        const swapContainer = document.getElementById(`swap-btn-container-${eventIndex}-${i}`);
                        if (swapContainer) swapContainer.innerHTML = '';
                    }
                }
                const sortContainer = document.getElementById(`sort-btn-container-${eventIndex}`);
                if (sortContainer) sortContainer.innerHTML = '';
                
                for (let i = 1; i <= state.rankCount; i++) {
                    const currentTime = ranks[i];
                    if (currentTime !== undefined && currentTime !== null) {
                        allRanksWithTime.push({ rank: i, time: currentTime }); 
                        if (lastValidTime !== -1 && currentTime < lastValidTime) {
                            errors.push({ rank1: lastValidRank, rank2: i });
                            conflictRanks.add(lastValidRank);
                            conflictRanks.add(i);
                        }
                        lastValidTime = currentTime;
                        lastValidRank = i;
                    } else { allRanksFilled = false; }
                }
                
                conflictRanks.forEach(rank => {
                    const cell = document.getElementById(`cell-${eventIndex}-${rank}`);
                    if (cell) cell.classList.add('error');
                });

                if (errors.length > 0) {
                    if (conflictRanks.size === 2) {
                        const { rank1, rank2 } = errors[0];
                        const swapContainer = document.getElementById(`swap-btn-container-${eventIndex}-${rank2}`);
                        if (swapContainer) swapContainer.innerHTML = createSwapButton(eventIndex, rank1, rank2);
                    } else if (conflictRanks.size > 2) {
                        errors.forEach(({ rank1, rank2 }) => {
                            const swapContainer = document.getElementById(`swap-btn-container-${eventIndex}-${rank2}`);
                            if (swapContainer) swapContainer.innerHTML = createSwapButton(eventIndex, rank1, rank2);
                        });
                        if (sortContainer && allRanksWithTime.length > 1) sortContainer.innerHTML = createSortButton(eventIndex);
                    }
                }
                
                const isAutoComplete = (allRanksFilled && conflictRanks.size === 0);
                const isManualComplete = event.manualComplete === true;
                
                if (isAutoComplete || isManualComplete) {
                    tr.classList.add('row-complete-highlight');
                }
            }
            
            function createSwapButton(eventIndex, rank1, rank2) {
                return `<button class="conflict-btn btn-swap" data-event-index="${eventIndex}" data-rank1="${rank1}" data-rank2="${rank2}" title="äº’æ›"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h18m-7.5-12L21 9m0 0L16.5 4.5M21 9H3"></path></svg> äº’æ›</button>`;
            }
            function createSortButton(eventIndex) {
                return `<button class="cell-sort-btn btn-sort-row" data-event-index="${eventIndex}" title="è‡ªå‹•æ’åº"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 4.5h14.25M3 9h14.25m-14.25 4.5h14.25M3 18h6.75"></path></svg></button>`;
            }
            function swapTimes(eventIndex, rank1, rank2) {
                if (!isFirebaseEnabled) return;
                const event = state.events[eventIndex];
                const time1 = event.ranks[rank1], time2 = event.ranks[rank2];
                const updates = {};
                updates[`${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank1}`] = time2;
                updates[`${APP_DATA_PATH}/events/${eventIndex}/ranks/${rank2}`] = time1;
                db.ref().update(updates);
            }
            function autoSortRow(eventIndex) {
                if (!isFirebaseEnabled) return;
                const event = state.events[eventIndex];
                let ranksWithTime = [];
                for (let rank in event.ranks) {
                    if (event.ranks[rank] !== undefined && event.ranks[rank] !== null) {
                        ranksWithTime.push({ rank: parseInt(rank), time: event.ranks[rank] });
                    }
                }
                if (ranksWithTime.length < 2) return;
                const originalRanks = ranksWithTime.map(item => item.rank);
                const sortedTimes = ranksWithTime.map(item => item.time).sort((a, b) => a - b);
                const newRanksObject = { ...event.ranks };
                originalRanks.forEach((rank, index) => newRanksObject[rank] = sortedTimes[index]);
                db.ref(`${APP_DATA_PATH}/events/${eventIndex}/ranks`).set(newRanksObject).then(() => showToast('è‡ªå‹•æ’åºå®Œæˆ'));
            }

            function openSaveRecordModal() { recordTitleInput.value = ''; saveRecordModal.classList.remove('hidden'); saveRecordModal.classList.add('visible'); recordTitleInput.focus(); }
            function closeSaveRecordModal() { saveRecordModal.classList.remove('visible'); saveRecordModal.classList.add('hidden'); }
            function handleSaveCloudRecord(e) {
                e.preventDefault();
                if (!isFirebaseEnabled) return;
                const title = recordTitleInput.value.trim();
                if (!title) return;
                
                // ä¿®æ”¹ï¼šåŠ å…¥ refereeConfig åˆ°å¿«ç…§è³‡æ–™ä¸­
                const recordData = { 
                    events: JSON.parse(JSON.stringify(state.events)), 
                    rankCount: state.rankCount,
                    refereeConfig: JSON.parse(JSON.stringify(state.refereeConfig || { names: [], assignments: {}, customRoles: [] }))
                };
                
                const snapshotObject = { title: title, data: recordData, createdAt: firebase.database.ServerValue.TIMESTAMP };
                db.ref(SNAPSHOTS_PATH).push(snapshotObject).then(() => { closeSaveRecordModal(); showToast(`å·²å„²å­˜å¿«ç…§: ${title}`); });
            }
            function loadCloudSnapshot(key) {
                if (!isFirebaseEnabled) return;
                db.ref(`${SNAPSHOTS_PATH}/${key}`).once('value').then(snapshot => {
                    if (!snapshot.exists()) return;
                    const record = snapshot.val();
                    showCustomConfirm('è¼‰å…¥å¿«ç…§', `ç¢ºå®šè¦è¼‰å…¥ "${record.title}" å—ï¼Ÿå°‡è¦†è“‹ç›®å‰æ‰€æœ‰é …ç›®ã€‚`, () => {
                        db.ref(APP_DATA_PATH).set(record.data).then(() => showToast('å¿«ç…§è¼‰å…¥æˆåŠŸ', 'success'));
                    });
                });
            }
            function deleteCloudSnapshot(key) {
                if (!isFirebaseEnabled) return;
                db.ref(`${SNAPSHOTS_PATH}/${key}`).remove().then(() => showToast('å¿«ç…§å·²åˆªé™¤'));
            }

            function openActionsModal() {
                if (state.isAdminAuthenticated) btnActionLogoutAdmin.classList.remove('hidden');
                else btnActionLogoutAdmin.classList.add('hidden');
                actionsModal.classList.remove('hidden'); actionsModal.classList.add('visible');
            }
            function closeActionsModal() { actionsModal.classList.remove('visible'); actionsModal.classList.add('hidden'); }
            function logoutAdminMode() {
                state.isAdminAuthenticated = false; adminModeBadge.classList.add('hidden');
                btnActionLogoutAdmin.classList.add('hidden'); 
                closeActionsModal(); 
                renderTable(); 
                showToast('å·²é€€å‡ºç®¡ç†è€…æ¨¡å¼', 'success');
            }
            
            function handleExportHtml() {
                if (!state.events || state.events.length === 0) { showToast('ç„¡è³‡æ–™å¯åŒ¯å‡º', 'error'); return; }
                try {
                    const htmlContent = generateStaticHtml();
                    const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    const timestamp = new Date().toISOString().slice(0, 16).replace('T', '_').replace(':', '-');
                    link.download = `è“®å°çµ‚é»è¨ˆæ™‚çµ„_å ±è¡¨_${timestamp}.html`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    showToast('HTML éœæ…‹å ±è¡¨å·²ä¸‹è¼‰', 'success');
                } catch (err) {
                    console.error('HTML ä¸‹è¼‰å¤±æ•—:', err);
                    showToast('HTML ä¸‹è¼‰å¤±æ•—', 'error');
                }
            }

function generateStaticHtml() {
                const rankCount = state.rankCount;
                let ths = `<th style="padding: 8px 10px; text-align: center; border: 1px solid #ccc; width: 50px;">åºè™Ÿ</th>`;
                ths += `<th style="padding: 8px 10px; text-align: left; border: 1px solid #ccc;">é …ç›®</th>`;
                for (let i = 1; i <= rankCount; i++) {
                    ths += `<th style="padding: 8px 10px; text-align: center; border: 1px solid #ccc; min-width: 80px;">${i} å</th>`;
                }
                let trs = '';
                
                (state.events || []).forEach((event, index) => {
                    if (!event) return;
                    const eventRanks = event.ranks || {};
                    const playerAssignments = event.playerAssignments || {}; // v2.6.0 Get assignments
                    
                    let allRanksFilled = true;
                    let hasErrors = false;
                    let lastTime = -1;
                    
                    for (let i = 1; i <= rankCount; i++) {
                        const timeInMs = eventRanks[i];
                        if (timeInMs === undefined || timeInMs === null) {
                            allRanksFilled = false;
                        } else {
                            if (lastTime !== -1 && timeInMs < lastTime) hasErrors = true;
                            lastTime = timeInMs;
                        }
                    }
                    const isComplete = (allRanksFilled && !hasErrors) || event.manualComplete;
                    const completeStyle = isComplete ? 'background-color: #dcfce7;' : ''; 

                    let tds = `<td style="padding: 6px 10px; text-align: center; border: 1px solid #ccc;">${index + 1}</td>`;
                    tds += `<td style="padding: 6px 10px; text-align: left; border: 1px solid #ccc; font-weight: 500;">${event.name}</td>`;
                    
                    lastTime = -1; 
                    for (let i = 1; i <= rankCount; i++) {
                        const timeInMs = eventRanks[i];
                        const timeText = (timeInMs === undefined || timeInMs === null) ? "" : formatMillis(timeInMs);
                        let isError = false;
                        if (timeInMs !== undefined && timeInMs !== null) {
                            if (lastTime !== -1 && timeInMs < lastTime) isError = true;
                            lastTime = timeInMs;
                        }
                        const errorStyle = isError ? 'background-color: #fee2e2; color: #ef4444; font-weight: bold;' : '';
                        
                        // v2.6.0 Export Player Name
                        let playerHtml = '';
                        if(playerAssignments[i]) {
                             playerHtml = `<div class="static-player-tag">${playerAssignments[i]}</div>`;
                        }

                        tds += `<td style="padding: 6px 4px; text-align: center; border: 1px solid #ccc; font-family: 'Courier New', monospace; ${errorStyle} vertical-align: middle;">${playerHtml}${timeText}</td>`;
                    }
                    const bgStyle = (index % 2 !== 0 && !isComplete) ? 'background-color: #f9fafb;' : ''; 
                    trs += `<tr style="${bgStyle} ${completeStyle}">${tds}</tr>`;
                });
                
                // v2.6.0 Added static-player-tag style
                const staticStyles = `
                    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans TC', sans-serif; background-color: #f3f4f6; padding: 20px; font-size: 14px; }
                    .container { max-width: 1200px; margin: 0 auto; background-color: white; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); overflow: hidden; }
                    h1 { text-align: center; margin: 20px 0; font-size: 24px; color: #333; }
                    table { width: 100%; border-collapse: collapse; }
                    thead { background-color: #e5e7eb; color: #1f2937; }
                    .static-player-tag { display: inline-block; font-size: 12px; color: #4b5563; background-color: #e5e7eb; padding: 1px 4px; border-radius: 4px; margin-bottom: 2px; }
                `;
                return `<!DOCTYPE html><html lang="zh-Hant"><head><meta charset="UTF-8"><title>çµ‚é»è¨ˆæ™‚å ±è¡¨</title><style>${staticStyles}</style></head><body><div class="container"><h1>ğŸ… è“®å°çµ‚é»è¨ˆæ™‚çµ„ - éœæ…‹å ±è¡¨</h1><table><thead><tr>${ths}</tr></thead><tbody>${trs}</tbody></table></div></body></html>`;
            }
// --- Referee Logic v2.3.0 ---
            const refereeModal = document.getElementById('referee-modal');
            const refereeListInput = document.getElementById('referee-list-input');
            const rankAssignmentsList = document.getElementById('rank-assignments-list');
            const customAssignmentsList = document.getElementById('custom-assignments-list');
            const btnActionReferee = document.getElementById('btn-action-referee'); // æ–°æŒ‰éˆ•

            function openRefereeModal() {
                // å¡«å…¥åå†Š
                const names = state.refereeConfig.names || [];
                refereeListInput.value = names.join('\n');
                renderRefereeUI();
                
                closeActionsModal();
                refereeModal.classList.remove('hidden');
                refereeModal.classList.add('visible');
            }

            function closeRefereeModal() {
                refereeModal.classList.remove('visible');
                refereeModal.classList.add('hidden');
            }

            function getRefereesFromInput() {
                return refereeListInput.value.split('\n').map(n => n.trim()).filter(n => n !== '');
            }

            function renderRefereeUI() {
                const currentNames = getRefereesFromInput();
                const assignments = state.refereeConfig.assignments || {};
                const customRoles = state.refereeConfig.customRoles || [];

                // 1. æ¸²æŸ“åæ¬¡åˆ†é… (Ranks)
                rankAssignmentsList.innerHTML = '';
                for (let i = 1; i <= state.rankCount; i++) {
                    const assignedName = assignments[i] || '';
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 bg-white p-2 rounded shadow-sm border border-gray-100';
                    div.innerHTML = `<span class="font-bold text-gray-500 w-12 text-center text-sm">ç¬¬ ${i} å</span><select class="referee-rank-select w-full text-sm p-1 border rounded" data-rank="${i}">${generateOptionsHtml(currentNames, assignedName)}</select>`;
                    rankAssignmentsList.appendChild(div);
                }

                // 2. æ¸²æŸ“è‡ªè¨‚å·¥ä½œ (Custom Roles)
                customAssignmentsList.innerHTML = '';
                customRoles.forEach((roleObj, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 bg-white p-2 rounded shadow-sm border border-gray-100 animate-fade-in';
                    div.innerHTML = `<input type="text" class="custom-role-name text-sm p-1 border rounded w-1/3 font-medium text-indigo-800 bg-indigo-50" placeholder="å·¥ä½œåç¨± (å¦‚: ç´…ç™½æ——)" value="${roleObj.role || ''}"><select class="custom-role-select w-full text-sm p-1 border rounded flex-grow">${generateOptionsHtml(currentNames, roleObj.name)}</select><button type="button" class="text-red-400 hover:text-red-600 p-1 btn-remove-custom-role">âœ–</button>`;
                    
                    // ç¶å®šåˆªé™¤äº‹ä»¶
                    div.querySelector('.btn-remove-custom-role').addEventListener('click', () => {
                        div.remove();
                    });
                    customAssignmentsList.appendChild(div);
                });
            }

            function generateOptionsHtml(names, selectedName) {
                let html = '<option value="">-- æœªåˆ†é… --</option>';
                names.forEach(name => {
                    const isSelected = name === selectedName ? 'selected' : '';
                    html += `<option value="${name}" ${isSelected}>${name}</option>`;
                });
                return html;
            }

            function addCustomRoleRow() {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 bg-white p-2 rounded shadow-sm border border-gray-100';
                const currentNames = getRefereesFromInput();
                div.innerHTML = `<input type="text" class="custom-role-name text-sm p-1 border rounded w-1/3 font-medium text-indigo-800 bg-indigo-50" placeholder="å·¥ä½œåç¨±"><select class="custom-role-select w-full text-sm p-1 border rounded flex-grow">${generateOptionsHtml(currentNames, '')}</select><button type="button" class="text-red-400 hover:text-red-600 p-1 btn-remove-custom-role">âœ–</button>`;
                 div.querySelector('.btn-remove-custom-role').addEventListener('click', () => div.remove());
                customAssignmentsList.appendChild(div);
                // æ»¾å‹•åˆ°åº•éƒ¨
                const container = document.getElementById('referee-assignments-container');
                container.scrollTop = container.scrollHeight;
            }

            function handleSaveReferee() {
                if (!isFirebaseEnabled) { showToast('é›¢ç·šæ¨¡å¼ç„¡æ³•å„²å­˜', 'error'); return; }
                
                const names = getRefereesFromInput();
                const newAssignments = {};
                
                // æ”¶é›†åæ¬¡åˆ†é…
                document.querySelectorAll('.referee-rank-select').forEach(select => {
                    if (select.value) {
                        newAssignments[select.dataset.rank] = select.value;
                    }
                });

                // æ”¶é›†è‡ªè¨‚å·¥ä½œ
                const newCustomRoles = [];
                document.querySelectorAll('#custom-assignments-list > div').forEach(div => {
                    const role = div.querySelector('.custom-role-name').value.trim();
                    const name = div.querySelector('.custom-role-select').value;
                    if (role && name) {
                        newCustomRoles.push({ role, name });
                    }
                });

                const newConfig = {
                    names: names,
                    assignments: newAssignments,
                    customRoles: newCustomRoles
                };

                db.ref(`${APP_DATA_PATH}/refereeConfig`).set(newConfig).then(() => {
                    closeRefereeModal();
                    showToast('âœ… è£åˆ¤è¨­å®šå·²å„²å­˜');
                });
            }
            // --- Event Listeners ---
            btnRankMinus.addEventListener('click', () => updateRankCount(-1));
            btnRankPlus.addEventListener('click', () => updateRankCount(1));
            btnOpenModal.addEventListener('click', openEventModal);
            btnCloseModal.addEventListener('click', closeEventModal);
            btnCancelModal.addEventListener('click', closeEventModal);
            eventModal.addEventListener('click', (e) => e.target === eventModal && closeEventModal());
            eventForm.addEventListener('submit', handleSaveEvent);
            timeInputForm.addEventListener('submit', handleSaveTime);
            btnCancelTime.addEventListener('click', closeTimeInputModal);
            timeInputModal.addEventListener('click', (e) => e.target === timeInputModal && closeTimeInputModal());
            
            // ç·¨è¼¯ Modal Event Listeners
            editEventModal.addEventListener('click', (e) => e.target === editEventModal && closeEditEventModal());
            btnCloseEditModal.addEventListener('click', closeEditEventModal);
            editEventForm.addEventListener('submit', handleSaveEditEvent);
            btnDecreaseIndex.addEventListener('click', () => adjustEditIndex(-1));
            btnIncreaseIndex.addEventListener('click', () => adjustEditIndex(1));
            btnDuplicateEvent.addEventListener('click', handleDuplicateEvent);
            btnDeleteEventModal.addEventListener('click', deleteEventFromModal);
			// v2.6.0 Clear Player Input
            btnClearPlayerInput.addEventListener('click', () => {
                if(confirm('ç¢ºå®šè¦æ¸…ç©ºè¼¸å…¥æ¡†å—ï¼Ÿå„²å­˜å¾Œå°‡æœƒä¸€ä½µç§»é™¤æ‰€æœ‰å·²åˆ†é…çš„é¸æ‰‹ã€‚')) {
                    editEventPlayersInput.value = '';
                    editEventPlayersInput.focus();
                }
            });

            btnDeleteTime.addEventListener('click', () => {
                if (!state.deleteTimeConfirmation) {
                    state.deleteTimeConfirmation = true;
                    btnDeleteTime.textContent = 'ç¢ºèªåˆªé™¤ï¼Ÿ';
                    btnDeleteTime.classList.replace('bg-red-50','bg-red-500');
                    btnDeleteTime.classList.replace('text-red-600','text-white');
                    state.deleteTimeTimeout = setTimeout(() => {
                        state.deleteTimeConfirmation = false;
                        btnDeleteTime.textContent = 'åˆªé™¤';
                        btnDeleteTime.classList.replace('bg-red-500','bg-red-50');
                        btnDeleteTime.classList.replace('text-white','text-red-600');
                    }, 3000);
                } else { handleDeleteTimeInternalLogic(); }
            });

            // Lap Selection Listeners v2.2.0
            btnCancelLapSelect.addEventListener('click', hideLapSelectionMenu);
            
            tableBody.addEventListener('click', (e) => {
                const target = e.target;
                const tr = target.closest('tr');
                if (!tr) return;
                const eventIndex = parseInt(tr.dataset.eventIndex);
                
                // v2.5.0 äº‹ä»¶åˆ¤æ–·é †åºï¼šå…ˆåˆ¤æ–·å°æŒ‰éˆ•/æ¨™ç±¤ï¼Œæœ€å¾Œæ‰æ˜¯æ•´å€‹å„²å­˜æ ¼
                if (target.closest('.btn-assign-player') || target.closest('.player-tag')) {
                    // é»æ“Šã€Œ+ã€æˆ–ã€Œé¸æ‰‹åå­—ã€é–‹å•Ÿé¸æ‰‹é¸æ“‡
                    e.stopPropagation(); // é˜»æ­¢å†’æ³¡ï¼Œé¿å…æ‰“é–‹æ™‚é–“è¼¸å…¥è¦–çª—
                    const rank = parseInt(target.closest('.time-cell').dataset.rank);
                    openPlayerSelectModal(eventIndex, rank);
                } else if (target.closest('.time-cell') && !target.closest('.conflict-btn')) {
                    openTimeInputModal(eventIndex, parseInt(target.closest('.time-cell').dataset.rank));
                } else if (target.closest('.btn-open-edit-modal')) { 
                    openEditEventModal(eventIndex); 
                } else if (target.closest('.btn-swap')) {
                    const { rank1, rank2 } = target.closest('.btn-swap').dataset;
                    swapTimes(eventIndex, rank1, rank2);
                } else if (target.closest('.btn-sort-row')) { 
                    autoSortRow(eventIndex); 
                } else if (target.closest('.btn-manual-ok')) { 
                    toggleManualComplete(eventIndex);
                }
            });
            
            tableHead.addEventListener('click', (e) => { if(e.target.closest('#btn-open-actions-modal')) openPasswordModal(openActionsModal); });
            btnCloseActionsModal.addEventListener('click', closeActionsModal);
            btnActionSave.addEventListener('click', () => { closeActionsModal(); if(!state.events.length) return showToast('ç„¡é …ç›®','error'); openSaveRecordModal(); });
            btnActionExportHtml.addEventListener('click', () => { closeActionsModal(); handleExportHtml(); });
            btnActionDeleteAll.addEventListener('click', () => { closeActionsModal(); if(!state.events.length) return; showCustomConfirm('åˆªé™¤å…¨éƒ¨','ç¢ºå®šï¼Ÿ', deleteAllEvents); });
            // è£åˆ¤ç›¸é—œäº‹ä»¶
            btnActionReferee.addEventListener('click', () => openPasswordModal(openRefereeModal));
            document.getElementById('btn-close-referee-modal').addEventListener('click', closeRefereeModal);
            document.getElementById('btn-cancel-referee').addEventListener('click', closeRefereeModal);
            document.getElementById('btn-save-referee').addEventListener('click', handleSaveReferee);
            document.getElementById('btn-clear-referees').addEventListener('click', () => { refereeListInput.value = ''; renderRefereeUI(); });
            document.getElementById('btn-add-custom-role').addEventListener('click', addCustomRoleRow);
            refereeListInput.addEventListener('input', renderRefereeUI); // å³æ™‚æ›´æ–°ä¸‹æ‹‰é¸å–®
			btnActionLogoutAdmin.addEventListener('click', logoutAdminMode);
            
            cloudSnapshotsContainer.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if(!btn) return;
                if(btn.classList.contains('saved-record-btn')) openPasswordModal(() => loadCloudSnapshot(btn.dataset.key));
                else if(btn.classList.contains('delete-record-btn')) openPasswordModal(() => showCustomConfirm('åˆªé™¤å¿«ç…§', 'ç¢ºå®šï¼Ÿ', () => deleteCloudSnapshot(btn.dataset.key)));
            });
            
            saveRecordForm.addEventListener('submit', handleSaveCloudRecord);
            btnCancelSaveRecord.addEventListener('click', closeSaveRecordModal);
            customConfirmOk.addEventListener('click', () => { if(state.confirmCallback) state.confirmCallback(); hideCustomConfirm(); });
            customConfirmCancel.addEventListener('click', hideCustomConfirm);
            passwordForm.addEventListener('submit', handlePasswordSubmit);
            btnCancelPassword.addEventListener('click', closePasswordModal);
// v2.5.0 Player Modal Events
            btnClosePlayerModal.addEventListener('click', closePlayerSelectModal);
            btnCancelPlayerSelect.addEventListener('click', closePlayerSelectModal);
            btnClearPlayer.addEventListener('click', clearAssignedPlayer);
            playerSelectModal.addEventListener('click', (e) => e.target === playerSelectModal && closePlayerSelectModal());
            // --- Stopwatch Event Listeners ---
            swToggleBtn.addEventListener('click', toggleStopwatchPanel);
            swBtnStart.addEventListener('click', startStopwatch);
            swBtnPause.addEventListener('click', pauseStopwatch);
            swBtnReset.addEventListener('click', () => resetStopwatch(false)); // Manual click triggers confirm
            swBtnLap.addEventListener('click', recordLap); 
            swBtnStop.addEventListener('click', stopStopwatch); 
            
            btnImportStopwatch.addEventListener('click', importStopwatchTime);
            btnImportSplits.addEventListener('click', importSplitTimes); 
            
            swSettingsToggle.addEventListener('click', () => {
                swSettingsMenu.classList.toggle('hidden');
            });
            toggleSound.addEventListener('change', (e) => state.stopwatch.settings.sound = e.target.checked);
            toggleVibration.addEventListener('change', (e) => state.stopwatch.settings.vibration = e.target.checked);
            toggleContinuous.addEventListener('change', toggleContinuousMode); 

            // --- Init ---
            function setupFirebaseListeners() {
                db.ref(".info/connected").on("value", (snap) => {
                    connectionStatusContainer.innerHTML = snap.val() === true 
                        ? `<div class="connection-status status-connected"><div class="status-dot"></div><span>å·²é€£ç·š</span></div>`
                        : `<div class="connection-status status-disconnected"><div class="status-dot"></div><span>é€£ç·šä¸­æ–·</span></div>`;
                });
                db.ref(APP_DATA_PATH).on("value", (snapshot) => {
                    const data = snapshot.val();
                    state.events = (data && data.events) ? data.events : [];
                    state.rankCount = (data && data.rankCount) ? data.rankCount : 7;
					// è®€å–è£åˆ¤è¨­å®š
                    state.refereeConfig = (data && data.refereeConfig) ? data.refereeConfig : { names: [], assignments: {}, customRoles: [] };
                    rankCountDisplay.textContent = state.rankCount;
                    renderTable();
                });
                db.ref(SNAPSHOTS_PATH).on('value', renderCloudSnapshots);
            }

            if (isFirebaseEnabled) {
                setupFirebaseListeners();
                showToast('v2.2.0 ç²¾æº–é¸æ™‚ç‰ˆè¼‰å…¥å®Œæˆ', 'success');
            } else {
                renderTable();
                showToast('æœ¬æ©Ÿé›¢ç·šæ¨¡å¼', 'error');
            }
        });
    </script>
</body>
</html>